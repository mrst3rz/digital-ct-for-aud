---
title: "Meta-Analysis on Digital Cognitive Training"
output:
  word_document:
    toc: true
    fig_width: 10
    fig_height: 6
    fig_caption: true
    reference_docx: template.docx
  html_document:
    toc: true
    fig_width: 10
    fig_height: 6
    fig_caption: true
  pdf_document:
    toc: true
mainfont: Times New Roman
editor_options:
  chunk_output_type: inline
zotero: true
bibliography: 
  - references.yaml
  - grateful-refs.bib
---

# 1. Introduction

This R Markdown report contains the entire script used for the meta-analysis on digital cognitive training among patients with alcohol use disorder.

It is build as an R Environment (`renv`) for managing R package versions and maximising the reproducibility for future analyses, and all package versions are stored in the renv.lock-file.

The packages needed for this report are `knitr`, `osfr`, `devtools`, `ggplot`, `robvis`, `readxl`, `openxlsx`, `dplyr`, `meta`, `grid`, and `grateful` .The `knitr` package is used for knitting the R markdown file to PDF or word.
The next three packages are used to create a traffic plot and a summary of the risk of bias ratings.
The `robvis` package-version required, is the latest developer-version, as this will display study labels horizontally.
The `readxl` and `openxlsx` packages are used for reading and opening the Excel dataset, whereas the `dplyr` package is used for transforming and preparing the data for the analyses.
All the effect sizes are calculated using the `meta` package, and forest and funnel plots are generated using this package as well.
The `grid` package, is used to add additional statistics to the plots that are not standard for the `meta` package.
Finally, to document all the packages used and the corresponding versions, we used the `grateful` package to create a summary and a list of references for each of the used packages in this analysis report.

## 1.1 Loading and installing the packages

To prepare the R environment for the analyses, we first need to install the required packages.

```{r package-setup, echo=TRUE, message=FALSE, warning=FALSE, include=TRUE}
# List of required CRAN packages
packages_required <- c("osfr", "rmarkdown", "knitr", "readxl", "openxlsx", "dplyr", "meta", 
                        "grid", "devtools", "tidyr", "tidyverse", "ggplot2", "grateful")

# Function to install missing CRAN packages
install_if_missing <- function(pkg) {
  if (!requireNamespace(pkg, quietly = TRUE)) {
    install.packages(pkg)
  }
}

# Install all missing CRAN packages
invisible(sapply(packages_required, install_if_missing))

# Load all the packages
invisible(lapply(packages_required, library, character.only = TRUE))

# Install robvis from GitHub to display study labels horizontally
if (!requireNamespace("robvis", quietly = TRUE)) {
  devtools::install_github("mcguinlu/robvis")
}

# Load latest robvis-version
library(robvis)
```

A snapshot of the R environment can be performed, after the packages have been installed by running renv::snapshot.

```{r snapshot-renv, echo=FALSE, message=FALSE, warning=FALSE, include=FALSE}
# Snapshot the environment
renv::snapshot(prompt = FALSE)
```

```{r knitr-setup, message=FALSE, warning=FALSE, include=FALSE}
# Set the global knitr-settings for the present R markdown document
knitr::opts_chunk$set(
	message = FALSE,
	warning = FALSE,
	include = TRUE
)
```

```{r osf-auth-setup, echo=FALSE, message=FALSE, warning=FALSE, include=FALSE}
# Load the OSF token
osf_auth(token = Sys.getenv("OSF_TOKEN"))
```

First we load the project data from the online repository OSF, which is done with the package `osfr`.
This can be skipped, if the data has already been stored locally.
A token for accessing the project data is needed during the embargo period.

```{r osf-proj-load, echo=TRUE, message=FALSE, warning=FALSE, include=TRUE}
# Get the OSF project node
osf_proj <- osf_retrieve_node("3s2mr")

# List all folders inside the project
osf_folders <- osf_ls_files(osf_proj, type = "folder")

# First, get the folder named "Risk of bias data"
osf_rob_folder <- osf_folders %>%
  filter(name == "Risk of bias data") %>%
  pull(id)

# Then, get the folder named "Clinical outcome data"
osf_clinical_folder <- osf_folders %>%
  filter(name == "Clinical outcome data") %>%
  pull(id)

# Retrieve both folders using osf_retrieve_file
osf_rob_folder <- osf_retrieve_file(osf_rob_folder)
osf_clinical_folder <- osf_retrieve_file(osf_clinical_folder)

# List files inside the folders
osf_rob_files <- osf_ls_files(osf_rob_folder)
osf_clinical_files <- osf_ls_files(osf_clinical_folder)

# Filter and download the desired Excel file on risk of bias data
osf_rob_files <- osf_rob_files %>%
  filter(name == "Risk of Bias Data.csv") %>%
  osf_download(path = tempdir(), conflicts = "overwrite")

# Filter and download the desired Excel file on clinical outcomes
osf_clinical_files <- osf_clinical_files %>%
  filter(name == "Extracted Clinical Outcome Data.xlsx") %>%
  osf_download(path = tempdir(), conflicts = "overwrite")
```

## 1.3 Importing risk of bias data

Before conducting the meta-analyses, we want to create two plots for the risk of bias (RoB) assessments for the included studies.
We used the revised version of the risk of bias tool (RoB 2), and the plots adhere to the domains specified by @sterne2019.

The first step to display the risk of bias results, requires that a separate data set is imported, and as this file is formatted as a csv-file, we can use the readr-package.

```{r import-rob, echo=TRUE, message=FALSE, warning=FALSE, include=TRUE}
# Importing csv-file containing the RoB data set
rob_d <- read.csv(osf_rob_files$local_path, sep = ";", header = TRUE)
```

## 1.4 Displaying the risk of bias

After the data set has been imported, we can create the traffic light plot using the function called rob_traffic_light(), which will display the individual ratings for each domain for each of the included studies.

```{r traffic-plot, echo=TRUE, fig.height=8, fig.width=8, message=FALSE, warning=FALSE, include=TRUE, fig.cap="Traffic plot of individual risk of bias ratings"}
# Create a traffic plot displaying individual bias ratings
rob_traffic_light(rob_d, tool = "ROB2", psize = 7)
```

To display the summary of risk of bias across the domains including the overall risk of bias, we can create a new bar plot using the rob_summary() function.
To begin with we set the weighted parameter to FALSE, as we will calculate the weights at the end of the report.

```{r rob-summary, fig.height=6, fig.width=10, message=FALSE, warning=FALSE, include=TRUE, fig.cap="Summary of risk of bias ratings"}
# Create a summary (barplot) of risk of bias assessments
rob_summary(rob_d, tool = "ROB2", weighted = FALSE) # weighted barplot will be created later
```

# 2. Primary analyses on short-term effects (0-3 months)

Now that the required libraries have been installed and loaded, we can initiate the primary analyses.
For this first part of our primary analysis, we import the excel-dataset "Extracted Clinical Outcome Data".

## 2.1 Short-term effects on continuous abstinence

As we are starting with our primary outcome of continuous abstinence (CA), we only need to import the first sheet of the dataset named "Abstinence".
These analyses will also be performed on the short-term effects, which means that we will need to filter the time point to "0-3 months".

```{r importing-ca-3m-data, echo=TRUE, message=FALSE, warning=FALSE, include=TRUE}
# Import data on abstinence as "ca_d" and preserve original order of studies
ca_d <- read_excel(osf_clinical_files$local_path, sheet = "Abstinence") %>%
  mutate(row_id = row_number())
```

### 2.1.1 Conversion of continuous and categorical variables

We have identified two studies @grieder2022 and @stein2023, who both reported percentage of days abstinent (PDA), which we can include in our analyses by converting the continuous outcomes to the natural logarithm of the odds ratio (lnOR) using the formula proposed by @chinn2000:

$$
{\ln}OR=SMD\frac{\pi}{\sqrt3}
$$

Furthermore, we are able to convert our dichotomous outcomes on CA, when we have the lnOR, the Chinn-formula can be used to convert these values to SMDs:

$$
SMD={\ln}OR\frac{\sqrt3}{\pi}
$$

These two functions can be defined for easier conversions of the effect sizes as we proceed with the analyses, and for simplicity we define their respective factors (Chinn-factor).

```{r defining-chinn-factor, echo=TRUE, message=FALSE, warning=FALSE, include=TRUE}
# Chinn-factor for converting standard error (SE) of SMD to SE of lnOR
chinn_smd_to_lnor <- (pi / sqrt (3))

# Chinn-factor for converting SE of lnOR to SE of SMD
chinn_lnor_to_smd <- (sqrt(3) / pi)
```

### 2.1.2 Calculation of effect sizes for continuous outcomes

As the primary analyses only include the outcomes reported after 0-3 months, we first need to filter the dataset and store it as a new subset.

```{r ca-3m-filter, echo=TRUE, message=FALSE, warning=FALSE, include=TRUE}
# Filter 0â€“3 month data first and store it as a new subset
ca_d_3m <- ca_d %>% filter(time_point == "0-3 months")
```

The calculation of effect sizes will be done by the inbuilt functions in the `meta` package [@balduzzi2019], so for the continuous variables, we will use the metacont() function, whereas for the categorical variables, we will use the metabin() function.
As these two functions need to be run separately, we will need to filter the studies, who report on PDA, and define it as a subset of our data.
The studies who do not report on PDA and only dichotomous outcomes, are also filtered and stored as a subset.
This can be achieved by filtering studies, which have no empty cells for the "e_abs_trans_mean" columns, and for storing categorical variables, we can impose the opposite filtering rule.

```{r ca-3m-dtype-filter, echo=TRUE, message=FALSE, warning=FALSE, include=TRUE}
# Filter studies with PDA and store it as a new dataset
ca_d_cont_3m <- ca_d_3m %>% filter(!is.na(e_abs_trans_mean))

# Filter studies only with dichotomous outcomes and store it as a new dataset
ca_d_cat_3m <- ca_d_3m %>% filter(is.na(e_abs_trans_mean))
```

Now it is possible to calculate the standard mean differences (SMDs) for the studies reporting PDA by using metacont().
We apply the small study correction using Hedge's *g*, as the study by @grieder2022 included a small sample size.
Furthermore, we apply the restricted maximum likelihood (REML) and random modelling will be used for our meta-analysis.

```{r ca-3m-metacont, echo=TRUE, message=FALSE, warning=FALSE, include=TRUE}
# Calculating the SMDs (Hedge's g) using metacont()
ca_metacont_3m <- metacont(
  n.e = e_n,
  mean.e = e_abs_trans_mean,
  sd.e = e_abs_trans_sd,
  n.c = c_n,
  mean.c = c_abs_trans_mean,
  sd.c = c_abs_trans_sd,
  studlab = study,
  data = ca_d_cont_3m,
  sm = "SMD",
  method.smd = "Hedges",
  method.tau = "REML",
  method.random.ci = "classic",
  random = TRUE
)
```

After we have calculated the SMDs, we can create a new dataset or data frame and store these values alongside with the other relevant variables (e.g., time point, number of abstinents, etc.) from our original dataset.
We will extract the SMD, the standard error (SE) and the 95% confidence interval (CI).

```{r ca-3m-predata, echo=TRUE, message=FALSE, warning=FALSE, include=TRUE}
# Combine the SMDs calculated with original variables and store it in a new data frame
ca_d_sumcont_3m <- data.frame(
  row_id = ca_d_cont_3m$row_id,
  study = ca_metacont_3m$studlab,
  time_point = ca_d_cont_3m$time_point,
  super_domain = ca_d_cont_3m$super_domain,
  cog_domain = ca_d_cont_3m$cog_domain,
  total_n = ca_d_cont_3m$e_n + ca_d_cont_3m$c_n, # Calculating total number of participants
  c_n = ca_d_cont_3m$c_n,
  c_abs = NA,
  c_non_abs = NA,
  e_n = ca_d_cont_3m$e_n,
  e_abs = NA,
  e_non_abs = NA,
  # Adding calculated SMDs to the dataframe 
  SMD = ca_metacont_3m$TE,
  SE = ca_metacont_3m$seTE,
  LCI = ca_metacont_3m$lower,
  UCI = ca_metacont_3m$upper,
  check.names = FALSE # Removing the period as a space
)
```

The SMDs for the two studies can now be converted to lnOR using the pre-defined Chinn-factor, and alongside them, we can exponentiate these values to obtain the ORs.
Lastly, we calculate the z- and p-values and store them in the final data frame for the two studies.

```{r ca-3m-postdata, echo=TRUE, message=FALSE, warning=FALSE, include=TRUE}
# Fetching the previously stored data frame and adding the lnORs, their SE and 95% CI
ca_d_sumcont_3m <- ca_d_sumcont_3m %>% 
  data.frame(
    lnOR = ca_metacont_3m$TE * chinn_smd_to_lnor,
    SElnOR = ca_metacont_3m$seTE * chinn_smd_to_lnor,
    lnLCI = ca_metacont_3m$lower * chinn_smd_to_lnor,
    lnUCI = ca_metacont_3m$upper * chinn_smd_to_lnor,
  # Saving the ORs and its corresponding SE and 95% CI
    OR = exp(ca_metacont_3m$TE * chinn_smd_to_lnor),
    OrSE = exp(ca_metacont_3m$TE * chinn_smd_to_lnor) * (ca_metacont_3m$seTE * chinn_smd_to_lnor),
    OrLCI  = exp(ca_metacont_3m$lower * chinn_smd_to_lnor),
    OrUCI  = exp(ca_metacont_3m$upper * chinn_smd_to_lnor),
  # Calculating the z- and p-values
     `z-value` = (ca_metacont_3m$TE * chinn_smd_to_lnor) / (ca_metacont_3m$seTE * chinn_smd_to_lnor
                                                          ),
    `p-value` = 2 * (1 - pnorm(abs((ca_metacont_3m$TE * chinn_smd_to_lnor) / (ca_metacont_3m$seTE * chinn_smd_to_lnor
                                                                                  )))),
  # Adding a note to specify how the data was calculated
    Notes = "Categorical variables converted from continuous outcome (metacont) using Chinn's formula",
    check.names = FALSE
)
```

### 2.1.3 Calculation of effect sizes for categorical outcomes

The next step is to repeat the above procedure, but this time on our categorical data using metabin().

```{r ca-3m-metabin, echo=TRUE, message=FALSE, warning=FALSE, include=TRUE}
# Calculating the lnORs using metabin()
ca_metabin_3m <- metabin(
  event.e = e_abs,
  n.e = e_n,
  event.c = c_abs,
  n.c = c_n,
  studlab = study,
  data = ca_d_cat_3m,
  sm = "OR",
  method.tau = "REML",
  method.random.ci = "classic",
  random = TRUE,
  incr = 0.5,
  allstudies = TRUE
)
```

After we have calculated the lnORs, we can create a new data frame and store these values alongside with the other relevant variables (e.g., time point, number of abstinents, etc.) from our original dataset.
As performed for the continuous outcomes, we calculate the ORs and SMDs using the Chinn-factor.
Finally, we add the z- and p-values to the data-frame.

```{r ca-3m-predata-last, echo=TRUE, message=FALSE, warning=FALSE, include=TRUE}
# Fetching the previously stored data frame and adding the lnORs, their SE and 95% CI
ca_d_sumbin_3m <- data.frame(
  row_id = ca_d_cat_3m$row_id,
  study = ca_metabin_3m$studlab,
  time_point = ca_d_cat_3m$time_point,
  super_domain = ca_d_cat_3m$super_domain,
  cog_domain = ca_d_cat_3m$cog_domain,
  total_n = ca_d_cat_3m$e_n + ca_d_cat_3m$c_n,
  c_n = ca_d_cat_3m$c_n,
  c_abs = ca_d_cat_3m$c_abs,
  c_non_abs = ca_d_cat_3m$c_n - ca_d_cat_3m$c_abs,
  e_n = ca_d_cat_3m$e_n,
  e_abs = ca_d_cat_3m$e_abs,
  e_non_abs = ca_d_cat_3m$e_n - ca_d_cat_3m$e_abs,
# Extracting the lnORs from the metabin results
  lnOR = ca_metabin_3m$TE,
  SElnOR = ca_metabin_3m$seTE,
  lnLCI = ca_metabin_3m$lower,
  lnUCI = ca_metabin_3m$upper,
# Calculating the ORs from the metabin results
  OR = exp(ca_metabin_3m$TE),
  OrSE = exp(ca_metabin_3m$TE) * ca_metabin_3m$seTE,
  OrLCI = exp(ca_metabin_3m$lower),
  OrUCI = exp(ca_metabin_3m$upper),
# Caculating the SMD, SE and 95% CI using the Chinn-function
  SMD = ca_metabin_3m$TE * chinn_lnor_to_smd,
  SE = ca_metabin_3m$seTE * chinn_lnor_to_smd,
  LCI = ca_metabin_3m$lower * chinn_lnor_to_smd,
  UCI = ca_metabin_3m$upper * chinn_lnor_to_smd,
# Adding the z- and p-values
  `z-value` = ca_metabin_3m$TE / ca_metabin_3m$seTE,
  `p-value` = 2 * (1 - pnorm(abs(ca_metabin_3m$TE / ca_metabin_3m$seTE))),
# Adding a final note on how data was converted    
  Notes = "Continuous variables converted from categorical outcome (metabin) using Chinn's formula",
  check.names = FALSE
)
```

Now that the categorical data has been stored in a separate data frame, we can combine it with the data frame for continuous data for so it can be used for our meta-analysis.

```{r ca-3m-combined, echo=TRUE, message=FALSE, warning=FALSE, include=TRUE}
# Combine the two data frames for CA and round all the values 5 decimals
ca_d_full_3m <- bind_rows(ca_d_sumcont_3m, ca_d_sumbin_3m) %>% mutate(across(where(is.numeric), ~ round(.x, 5))) %>%
  # Arrange the studies by their pre-defined row-numbers
  arrange(row_id)
```

### 2.1.4 Meta-analysis on continuous abstinence

The short-term effects (0-3 months) of cognitive training on CA has now been calculated, and the studies with missing categorical outcomes have been converted, so our primary analyses now includes 11 studies.
Before we can proceed with creating a forest plot, we need to rename the study IDs, which only purpose was differentiate different outcomes at across various time points in each of the studies.
We start by defining new study labels.

```{r define-study-labels, echo=TRUE, message=FALSE, warning=FALSE, include=TRUE}
# Creating study labels in accordance with APA
study_labels <- c(
  "1_chen_2022" = "Chen et al. (2022)",
  "2a_uyl_2018" = "Uyl et al. (2018)",
  "2b_uyl_2018" = "Uyl et al. (2018)",
  "3a_dubuson_2021" = "Dubuson et al. (2021)",
  "3c_dubuson_2021" = "Dubuson et al. (2021)",
  "3e_dubuson_2021" = "Dubuson et al. (2021)",
  "3d_dubuson_2021" = "Dubuson et al. (2021)",
  "4_eberl_2013" = "Eberl et al. (2013)",
  "5b_manning_2022" = "Manning et al. (2022)",
  "5c_manning_2022" = "Manning et al. (2022)",
  "5d_manning_2022" = "Manning et al. (2022)",
  "5f_garfield_2022" = "Garfield et al. (2022)",
  "5g_garfield_2022" = "Garfield et al. (2022)",
  "5h_garfield_2022" = "Garfield et al. (2022)",
  "6_grieder_2022" = "Grieder et al. (2022)",
  "7c_garfield_2024" = "Garfield et al. (2024)",
  "8b_kvamme_2019"   = "Kvamme et al. (2019)",
  "9b_kumar_2019" = "Kumar et al. (2019)",
  "9c_kumar_2019" = "Kumar et al. (2019)",
  "10b_laurens_2023" = "Laurens et al. (2023)",
  "10c_laurens_2023" = "Laurens et al. (2023)",
  "11_manning_2016" = "Manning et al. (2016)",
  "12a_peerenboom_2022" = "Peerenboom (2022)",
  "12b_peerenboom_2022" = "Peerenboom (2022)",
  "13a_rinck_2018" = "Rinck et al. (2018)",
  "14a_schenkel_2023" = "Schenkel et al. (2023)",
  "14b_schenkel_2023" = "Schenkel et al. (2023)",
  "15a_schenkel_2024" = "Schenkel et al. (2024)",
  "15b_schenkel_2024" = "Schenkel et al. (2024)",
  "15c_schenkel_2024" = "Schenkel et al. (2024)",
  "16a_schoenmakers_2010" = "Schoenmakers et al. (2010)",
  "16b_schoenmakers_2010" = "Schoenmakers et al. (2010)",
  "17b_stein_2023" = "Stein et al. (2023)",
  "18a_wiers_2011" = "Wiers et al. (2011)",
  "18b_wiers_2011" = "Wiers et al. (2011)"
)
```

After these have been defined as values, we can assign them to our data frame on short-term effects on CA.

```{r ca-3m-assign-labels, echo=TRUE, message=FALSE, warning=FALSE, include=TRUE}
# Assign the new study labels to the combined data frame
ca_d_full_3m$study <- ifelse(ca_d_full_3m$study %in% names(study_labels),
                            study_labels[ca_d_full_3m$study],
                            ca_d_full_3m$study)
```

We want to have the author labels to be sorted alphabetically rather than in accordance with the pre-specified study IDs and row numbers, so we first arrange the list of studies.

```{r ca-3m-arrange-alpha, echo=TRUE, message=FALSE, warning=FALSE, include=TRUE}
# Arrange studies alphabetically
ca_d_full_3m <- ca_d_full_3m %>%
  arrange(desc(study == "Dubuson et al. (2021)"),
          desc(study == "Grieder et al. (2022)"),
          desc(study == "Kvamme et al. (2019)"),
          desc(study == "Manning et al. (2016)"),
          desc(study == "Manning et al. (2022)"),
          desc(study == "Peerenboom (2022)"),
          desc(study == "Schenkel et al. (2023)"),
          desc(study == "Schenkel et al. (2024)"),
          desc(study == "Schoenmakers et al. (2010)"),
          desc(study == "Stein et al. (2023)")
          )
```

As we want to display number of events and total number of participants in each group for the individual studies in the forest plot, we need to prepare data frame with missing event data (i.e., studies reporting PDA) by defining missing values as NAs.

```{r ca-3m-assign-nas, echo=TRUE, message=FALSE, warning=FALSE, include=TRUE}
# Assign NAs strings to studies with missing event data
ca_d_full_3m <- ca_d_full_3m%>%
  mutate(across(c(e_abs, e_non_abs, e_n, c_abs, c_non_abs, c_n), ~ ifelse(is.na(.), "NA", as.character(.))))
```

To make it clearer in the final forest plot, we assign new variable names to the two subgroups, and sort them with the subgroup with the lowest number of studies on top.

```{r ca-3m-rename-subgroups, echo=TRUE, message=FALSE, warning=FALSE, include=TRUE}
# Assigning new variable names to the subgroups
ca_d_full_3m <- ca_d_full_3m %>%
  dplyr::rename(Subgroup = super_domain) %>%
  dplyr::mutate( # Changing the order of the two subgroups
    Subgroup = factor(Subgroup,
                      levels = c("Explicit", "Implicit"),
                      labels = c("Explicit cognition", "Implicit cognition"))
    )
```

With the new subgroup names, we can pool the effects across studies and stratify by the superordinate domains targeted by the cognitive training programs (i.e., explicit and implicit cognition) used in each study.
This is achieved by using metagen(), where we define our treatment effect (TE) as the lnOR and corresponding standard error of the treatment effect (seTE) as the SE of the lnOR.
We apply a random effects model using REML and use a classic *z*-test.

```{r ca-3m-metagen, echo=TRUE, message=FALSE, warning=FALSE, include=TRUE}
# Run the meta-analysis stratified by superordinate domains and using the new labels
ca_metagen_3m <- metagen(TE = lnOR,
                    seTE = SElnOR,
                    studlab = study,
                    data = ca_d_full_3m,
                    subgroup = Subgroup,
                    sm = "OR",
                    method.tau = "REML",
                    common = FALSE,
                    random = TRUE,
                    method.random.ci = "classic")

# Print the results of the meta-analysis
print(ca_metagen_3m)
```

The test statistics for the overall pooled effect size as well as the subgroup effect sizes have now been calculated, but by default, these are not displayed in the forest plot created with the forest()-function in the meta-package.
These values can be displayed, if we first extract the test statistics and store them as separate data-frames.
The data frames can then be added manually to the forest plot with the grid-package.

```{r ca-3m-zp-values, echo=TRUE, message=FALSE, warning=FALSE, include=TRUE}
# Extract the test statistics for the overall effect and create a data frame
ca_zp_overall_3m <- data.frame(
  lnOR = ca_metagen_3m$TE.random,
  lnOR_se = ca_metagen_3m$seTE.random,
  z_value = ca_metagen_3m$statistic.random,
  p_value = ca_metagen_3m$pval.random
)

# Extract the test statistics for the subgroup analysis and create a data frame
ca_zp_subgroup_3m <- data.frame(
  subgroup = ca_metagen_3m$bylevs,
  lnOR = ca_metagen_3m$TE.random.w,
  lnOR_se = ca_metagen_3m$seTE.random.w,
  z_value = ca_metagen_3m$statistic.random.w,
  p_value = ca_metagen_3m$pval.random.w
)
```

For an easier way to add the individual effect sizes for each subgroup in the final forest plot, we can create a split of the data frame.

```{r ca-3m-subgroup-split, echo=TRUE, message=FALSE, warning=FALSE, include=TRUE}
# Split the previously defined data frame by each superordinate domain
ca_zp_subsplit_3m <- split(ca_zp_subgroup_3m, ca_zp_subgroup_3m$subgroup)
```

With the final preparation completed, we can plot the forest plot using the random effects model with the additional test statistics added with the grid-package.
The forest plot uses the BMJ layout (i.e., added weights for the individual studies) and it shows the number of events (i.e., abstinents), the group size for both the intervention (i.e., Intv.) and the control group (i.e., Ctrl), OR effects for individual studies across subgroups as well as the overall effect.
A prediction interval is added to the pooled effect sizes.
For the heterogeneity analyses, we report the Cochran's *Q* statistic, its *p*-value as well as the measure of absolute variance using $I^2$.

```{r ca-3m-forest, fig.height=7, fig.width=12, message=FALSE, warning=FALSE, include=TRUE, fig.cap="Forest plot for the effects on continuous abstinence"}
# Now plot the forest plot again with new subgroup names
forest(ca_metagen_3m,
       prediction = TRUE,
       prediction.subgroup = TRUE,
       layout = "BMJ",
       subgroup = TRUE,
       overall = TRUE,
       random = TRUE,
       common = FALSE,
       test.subgroup = FALSE,
       print.stat = FALSE,
       print.I2 = TRUE,
       print.Q = TRUE,
       print.pval.Q = TRUE,
       print.tau2 = FALSE,
       label.left = "Favors Control",
       label.right = "Favors Intervention",
       spacing = 1.2,
       fontsize = 10,
       digits = 2,
       leftcols = c("studlab", "e_abs", "e_n", "c_abs", "c_n"),
       leftlabs = c("Study", "Intv. (events)", "Total (n)", 
                    "Ctrl. (events)", "Total (n)"),
       just.addcols = "center"
       )


# Add a footer for the test statistics of the effects for explicit cognition
footer_exp_ca_3m <- paste0(
  "Subgroup effect | ",
  paste0(
    ca_zp_subsplit_3m$`Explicit cognition`,
    ": z = ", round(ca_zp_subsplit_3m$`Explicit cognition`$z_value, 2),
    ", p = ", formatC(ca_zp_subsplit_3m$`Explicit cognition`$p_value, digits = 2)
  )
)

# Add a footer for the test statistics of the effects for implicit cognition
footer_imp_ca_3m <- paste0(
  "Subgroup effect | ",
  paste0(
    ca_zp_subsplit_3m$`Implicit cognition`,
    ": z = ", round(ca_zp_subsplit_3m$`Implicit cognition`$z_value, 2),
    ", p = ", formatC(ca_zp_subsplit_3m$`Implicit cognition`$p_value, digits = 2)
  )
)

# Add a footer combining the test statistics for the overall effect
footer_over_ca_3m <- paste0(
  "Overall effect: ",
  paste0(
    "z = ", round(ca_zp_overall_3m$z_value, 2),
    ", p = ", formatC(ca_zp_overall_3m$p_value, digits = 2),
    collapse = "; "
  )
)

# Adjust the footer for the subgroup effects after explicit subgroup
grid.text(footer_exp_ca_3m, x = 0.092, y = 0.72,
          just = "left", gp = gpar(fontsize = 8))

# Adjust the footer for the subgroup effects after implicit subgroup
grid.text(footer_imp_ca_3m, x = 0.092, y = 0.21,
          just = "left", gp = gpar(fontsize = 8))

# Adjust the footer for the overall effect to the bottom left
grid.text(footer_over_ca_3m, x = 0.092, y = 0.045,
          just = "left", gp = gpar(fontsize = 9))
```

### 2.1.5 Sensitivity analysis for continuous abstinence

In the primary analysis, we included two studies that did not report a categorical outcome for continuous abstinence, which can introduce measurement error and increase the heterogeneity.
Thus, we also conduct a sensitivity analysis, where these two studies are excluded, to see how this affects the overall results.
To achieve this, we can start by filtering out these two studies by the study label in our previously defined data frame.

```{r ca-3m-sens-filter, echo=TRUE, message=FALSE, warning=FALSE, include=TRUE}
# Exclude the study by Grieder and Stein and store a new data frame
ca_d_sens_filter_3m <- ca_d_full_3m %>% 
  filter(!study %in% c("Grieder et al. (2022)", "Stein et al. (2023)"))
```

We want to re-arrange the study labels in alphabetical order rather then by the pre-defined row numbers.

```{r ca-3m-sens-arrange, echo=TRUE, message=FALSE, warning=FALSE, include=TRUE}
# Arrange studies alphabetically
ca_d_sens_filter_3m <- ca_d_sens_filter_3m %>%
  arrange(desc(study == "Dubuson et al. (2021)"),
          desc(study == "Kvamme et al. (2019)"),
          desc(study == "Manning et al. (2016)"),
          desc(study == "Manning et al. (2022)"),
          desc(study == "Peerenboom (2022)"),
          desc(study == "Schenkel et al. (2023)"),
          desc(study == "Schenkel et al. (2024)"),
          desc(study == "Schoenmakers et al. (2010)")
          )
```

Now that the data set has been filtered, we can run the metagen()-function again, this time with our filtered data frame.
We still want to run the analysis stratified by the previously defined subgroups.

```{r ca-3m-sens-metagen, echo=TRUE, message=FALSE, warning=FALSE, include=TRUE}
# Run the meta-analysis stratified by superordinate domains
ca_sens_metagen_3m <- metagen(TE = lnOR,
                    seTE = SElnOR,
                    studlab = study,
                    data = ca_d_sens_filter_3m,
                    subgroup = Subgroup,
                    sm = "OR",
                    method.tau = "REML",
                    common = FALSE,
                    random = TRUE,
                    method.random.ci = "classic")

# Print the results of the meta-analysis
print(ca_sens_metagen_3m)
```

The test statistics for the newly calculated effect sizes can now be extracted, and prepared for our forest plot.

```{r ca-3m-sens-zp-values, echo=TRUE, message=FALSE, warning=FALSE, include=TRUE}
# Extract the test statistics for the overall effect and create a data frame
ca_zp_sens_over_3m <- data.frame(
  lnOR = ca_sens_metagen_3m$TE.random,
  lnOR_se = ca_sens_metagen_3m$seTE.random,
  z_value = ca_sens_metagen_3m$statistic.random,
  p_value = ca_sens_metagen_3m$pval.random
)

# Extract the test statistics for the subgroup analysis and create a data frame
ca_zp_sens_sub_3m <- data.frame(
  subgroup = ca_sens_metagen_3m$bylevs,
  lnOR = ca_sens_metagen_3m$TE.random.w,
  lnOR_se = ca_sens_metagen_3m$seTE.random.w,
  z_value = ca_sens_metagen_3m$statistic.random.w,
  p_value = ca_sens_metagen_3m$pval.random.w
)
```

For an easier way to add the individual effect sizes for each subgroup in the final forest plot, we can create a split of the data frame.

```{r ca-3m-sens-subgroup-split, echo=TRUE, message=FALSE, warning=FALSE, include=TRUE}
# Split the previously defined data frame by each superordinate domain
ca_zp_sens_subsplit_3m <- split(ca_zp_sens_sub_3m, ca_zp_sens_sub_3m$subgroup)
```

Now with the extracted test statistics, we can now plot the results of the sensitivity analysis and add additional information using the grid-package.
We use the same layout and measures for heterogeneity, which was used for our unadjusted analysis.

```{r ca-3m-sens-forest, fig.height=7, fig.width=12, message=FALSE, warning=FALSE, include=TRUE, fig.cap="Forest plot for the sensitivity analysis on continuous abstinence"}
# Forest plot for sensitivity analysis
forest(ca_sens_metagen_3m,
       prediction = TRUE,
       prediction.subgroup = TRUE,
       layout = "BMJ",
       subgroup = TRUE,
       overall = TRUE,
       random = TRUE,
       common = FALSE,
       test.subgroup = FALSE,
       print.stat = FALSE,
       print.I2 = TRUE,
       print.Q = TRUE,
       print.pval.Q = TRUE,
       print.tau2 = FALSE,
       label.left = "Favors Control",
       label.right = "Favors Intervention",
       spacing = 1.2,
       fontsize = 10,
       digits = 2,
       leftcols = c("studlab", "e_abs", "e_n", "c_abs", "c_n"),
       leftlabs = c("Study", "Intv. (events)", "Total (n)", 
                    "Ctrl. (events)", "Total (n)"),
       just.addcols = "center"
       )


# Add a footer for the test statistics of the effects for explicit cognition
footer_exp_ca_sens_3m <- paste0(
  "Subgroup effect | ",
  paste0(
    ca_zp_sens_subsplit_3m$`Explicit cognition`,
    ": z = ", round(ca_zp_sens_subsplit_3m$`Explicit cognition`$z_value, 2),
    ", p = ", formatC(ca_zp_sens_subsplit_3m$`Explicit cognition`$p_value, digits = 2)
  )
)

# Add a footer for the test statistics of the effects for implicit cognition
footer_imp_ca_sens_3m <- paste0(
  "Subgroup effect | ",
  paste0(
    ca_zp_subsplit_3m$`Implicit cognition`,
    ": z = ", round(ca_zp_subsplit_3m$`Implicit cognition`$z_value, 2),
    ", p = ", formatC(ca_zp_subsplit_3m$`Implicit cognition`$p_value, digits = 2)
  )
)

# Add a footer combining the test statistics for the overall effect
footer_over_ca_sens_3m <- paste0(
  "Overall effect: ",
  paste0(
    "z = ", round(ca_zp_sens_over_3m$z_value, 2),
    ", p = ", formatC(ca_zp_sens_over_3m$p_value, digits = 2),
    collapse = "; "
  )
)

# Adjust the footer for the subgroup effects after explicit subgroup
grid.text(footer_exp_ca_sens_3m, x = 0.092, y = 0.69,
          just = "left", gp = gpar(fontsize = 8))

# Adjust the footer for the subgroup effects after implicit subgroup
grid.text(footer_imp_ca_sens_3m, x = 0.092, y = 0.24,
          just = "left", gp = gpar(fontsize = 8))

# Adjust the footer for the overall effect to the bottom left
grid.text(footer_over_ca_sens_3m, x = 0.092, y = 0.09,
          just = "left", gp = gpar(fontsize = 9))

```

### 2.1.6 Publication bias for short-term effects on continuous abstinence

The final step for the primary analyses on continuous abstinence, is to assess the publication bias of the included studies.
We do this by conducting a meta-analysis once more, but this time we use the metagen()-function without stratifying for the subgroups.
We use the previously stored data frame combining categorical and continuous outcomes, and set the treatment effect to lnOR and the standard error of the treatment effect to SElnOR.

```{r ca-3m-publication-bias, echo=TRUE, message=FALSE, warning=FALSE, include=TRUE}
# Run meta-analysis without stratifying for subgroups
ca_pupbias_3m <- metagen(TE = lnOR,
                         seTE = SElnOR,
                         studlab = study,
                         sm = "OR",
                         method.tau = "REML",
                         data = ca_d_full_3m)

# Print the results of the meta-analysis without subgroups
print(ca_pupbias_3m)
```

As we want to both be able to visually inspect our plot for asymmetry as well as having a method of quantifying publication bias, we first want to conduct an Egger's test, which can be added to the final funnel plot.

```{r ca-3m-eggers-test, echo=TRUE, message=FALSE, warning=FALSE, include=TRUE}
# Conduct an Egger's test using the previosly calculated treatment effects
ca_egger_3m <- metabias(ca_pupbias_3m, method.bias = "Egger")

# Print the test results of the Egger's test
print(ca_egger_3m)
```

Now with the results from the Egger's test, we can now create the funnel plot using the meta-package inbuilt function funnel() and exponentiate the lnOR values to have the x-axis displaying ORs instead.
We can add the test statistic from the Egger's test to the funnel plot using mtext().

```{r ca-3m-funnel-plot, fig.height=8, fig.width=8, message=FALSE, warning=FALSE, include=TRUE, fig.cap="Funnel plot for studies on short-term effects on continuous abstinence"}
# Create a funnel plot using the newly stored data frame
funnel(ca_pupbias_3m,
       xlab = "Odds Ratio",
       studlab = TRUE,
       backtransf = TRUE,
       pch = 17,
       cex = 1)

# Add Egger's test statistic to the plot
ca_egger_text_3m <- paste0("Egger's test: p = ", 
                     round(ca_egger_3m$p.value, 3))

# Define the actual placement of the statistics on the funnel plot
mtext(ca_egger_text_3m, side=3, line=0.5, adj=0, cex=0.9, col="black")
```

## 2.2 Short-term effects on alcohol reduction

The first part of the primary analysis was on our primary outcome CA, now we can turn to analysing our secondary outcome on alcohol reduction.
We still need to use the excel-dataset "Extracted Clinical Outcome Data", but this time we import the sheet named "Reduction" and assign row numbers for an easier sorting of the studies.

```{r importing-red-3m-data, echo=TRUE, message=FALSE, warning=FALSE, include=TRUE}
# Import data on abstinence as "ca_d" and preserve original order of studies
red_d <- read_excel(osf_clinical_files$local_path, sheet = "Reduction") %>%
  mutate(row_id = row_number())
```

### 2.2.1 Calculation of effect sizes for continuous outcomes

For the primary analysis on alcohol reduction, we still want to focus on the time point "0-3 months", so we filter the data set by time point and re-arrange the studies in terms of alphabetical order.

```{r red-3m-filter, echo=TRUE, message=FALSE, warning=FALSE, include=TRUE}
# Filter 0â€“3 month data and arrange specific studies first
red_d_3m <- red_d %>%
  filter(time_point == "0-3 months") %>%
  arrange(desc(study == "7c_garfield_2024"),
          desc(study == "10b_laurens_2023"),
          desc(study == "11_manning_2016"))
```

As we only have continuous data for alcohol reduction, we only need to run the metacont() on our dataset to calculate the SMDs using Hedge's *g* correction.

```{r red-3m-metacont, echo=TRUE, message=FALSE, warning=FALSE, include=TRUE}
# Calculating the SMDs (Hedge's g) using metacont()
red_metacont_3m <- metacont(
  n.e = e_n,
  mean.e = e_reduc_mean,
  sd.e = e_reduc_sd,
  n.c = c_n,
  mean.c = c_reduc_mean,
  sd.c = c_reduc_sd,
  studlab = study,
  data = red_d_3m,
  sm = "SMD",
  method.smd = "Hedges",
  method.tau = "REML",
  method.random.ci = "classic",
  random = TRUE
)
```

Now we can combine the calculated effect sizes and add them to the original data set without changing the original variable names.

```{r red-3m-combined, echo=TRUE, message=FALSE, warning=FALSE, include=TRUE}
# Combine the SMDs calculated with original variables and store it in a new data frame
red_d_full_3m <- data.frame(
  row_id = red_d_3m$row_id,
  study = red_metacont_3m$studlab,
  time_point = red_d_3m$time_point,
  super_domain = red_d_3m$super_domain,
  cog_domain = red_d_3m$cog_domain,
  total_n = red_d_3m$e_n + red_d_3m$c_n, # Calculating total number of participants
  c_n = red_d_3m$c_n,
  c_reduc_mean = red_d_3m$c_reduc_mean,
  c_reduc_sd = red_d_3m$c_reduc_sd,
  e_n = red_d_3m$e_n,
  e_reduc_mean = red_d_3m$e_reduc_mean,
  e_reduc_sd = red_d_3m$e_reduc_sd,
  # Adding calculated SMDs to the dataframe 
  SMD = red_metacont_3m$TE,
  SE = red_metacont_3m$seTE,
  LCI = red_metacont_3m$lower,
  UCI = red_metacont_3m$upper,
  # Adding the z- and p-values
  `z-value` = red_metacont_3m$TE / red_metacont_3m$seTE,
  `p-value` = 2 * (1 - pnorm(abs(red_metacont_3m$TE / red_metacont_3m$seTE))),
  # Adding a final note on how data was converted    
  Notes = "Calculated using metacont()",
  check.names = FALSE # Removing the period as a space
)
```

### 2.2.2 Meta-analysis on alcohol reduction

After we have calculated the effect sizes and added them to the original data set, we can now assign the previously defined study labels to the data set.

```{r red-3m-assign-labels, echo=TRUE, message=FALSE, warning=FALSE, include=TRUE}
# Assign the new study labels to the combined data frame
red_d_full_3m$study <- ifelse(red_d_full_3m$study %in% names(study_labels),
                            study_labels[red_d_full_3m$study],
                            red_d_full_3m$study)
```

It is now possible to run the meta-analysis for alcohol reduction using the metagen() function, setting the Hedges *g* correction for the SMD and REML for the heterogeneity analysis.
However, as no study examined the effects of explicit cognitive training on alcohol reduction, we do not apply stratification by subgroups.

```{r red-3m-metagen, echo=TRUE, message=FALSE, warning=FALSE, include=TRUE}
# Run the meta-analysis stratified by superordinate domains and using the new labels
red_metagen_3m <- metagen(TE = SMD,
                    seTE = SE,
                    studlab = study,
                    data = red_d_full_3m,
                    sm = "SMD",
                    method.smd = "Hedges",
                    method.tau = "REML",
                    common = FALSE,
                    random = TRUE,
                    method.random.ci = "classic")

# Print the results of the meta-analysis
print(red_metagen_3m)
```

The test statistics can now be extracted from the meta-analysis and stored as a data frame for the forest plot.

```{r red-3m-zp-values, echo=TRUE, message=FALSE, warning=FALSE, include=TRUE}
# Extract the test statistics for the overall effect and create a data frame
red_zp_over_3m <- data.frame(
  SMD = red_metagen_3m$TE.random,
  SE = red_metagen_3m$seTE.random,
  z_value = red_metagen_3m$statistic.random,
  p_value = red_metagen_3m$pval.random
)
```

With the test statistics stored as a data frame, we now turn to creating the forest plot, which follows the same design as previously used for CA, however, no subgroup labels will be present, as only effects of implicit cognitive training on reduction was examined by the identified studies.

```{r red-3m-forest, fig.height=6, fig.width=11, echo=TRUE, message=FALSE, warning=FALSE, include=TRUE, fig.cap="Forest plot of effects on alcohol reduction"}
# Now plot the forest plot again with new subgroup names
forest(red_metagen_3m,
       prediction = TRUE,
       layout = "BMJ",
       overall = TRUE,
       random = TRUE,
       common = FALSE,
       print.stat = FALSE,
       print.I2 = TRUE,
       print.Q = TRUE,
       print.pval.Q = TRUE,
       print.tau2 = FALSE,
       label.left = "Favors Control",
       label.right = "Favors Intervention",
       spacing = 1.2,
       fontsize = 10,
       digits = 2,
       leftcols = c("studlab", "e_n", "e_reduc_mean", "e_reduc_sd", "c_n", "c_reduc_mean",
                    "c_reduc_sd"),
       leftlabs = c("Study", "Intv. (n)", "Mean", "SD", 
                    "Ctrl. (n)", "Mean", "SD"),
       just.addcols = "center"
       )

# Add a footer combining the test statistics for the overall effect
footer_over_red_3m <- paste0(
  "Overall effect: ",
  paste0(
    "z = ", round(red_zp_over_3m$z_value, 2),
    ", p = ", formatC(red_zp_over_3m$p_value, digits = 2),
    collapse = "; "
  )
)

# Adjust the footer for the overall effect to the bottom left
grid.text(footer_over_red_3m, x = 0.0385, y = 0.25,
          just = "left", gp = gpar(fontsize = 9))
```

### 2.2.3 Publication bias for short-term effects on alcohol reduction

The final step for the primary analyses on alcohol reduction, is to assess the publication bias of the included studies.
We can reuse the meta-analyses conducted in the section above for the funnel plot.
Instead, we can run a Egger's test, but due to a low number of studies, we need to set the minimum *k* to three studies.
The results will, however, be less reliable given the small number of studies, and interpretation of the results should be cautioned.

```{r red-3m-eggers-test, echo=TRUE, message=FALSE, warning=FALSE, include=TRUE}
# Conduct an Egger's test using the previously calculated treatment effects
red_egger_3m <- metabias(red_metagen_3m, method.bias = "Egger", k.min = 3)

# Print the results of the Egger's test
print(red_egger_3m)
```

Now with the results from the Egger's test, we can now create the funnel plot using the meta-package inbuilt function funnel().
We can add the test statistic from the Egger's test to the funnel plot using mtext().

```{r red-3m-funnel-plot, fig.height=8, fig.width=8, message=FALSE, warning=FALSE, include=TRUE, fig.cap="Funnel plot on studies for short-term effects on alcohol reduction"}
# Create a funnel plot using the newly stored data frame
funnel(red_metagen_3m,
       xlab = "Standardised Mean Difference",
       studlab = TRUE,
       pch = 17,
       cex = 1)

# Add Egger's test statistic to the plot
red_egger_text_3m <- paste0("Egger's test: p = ", 
                     round(red_egger_3m$p.value, 3))

# Define the actual placement of the statistics on the funnel plot
mtext(red_egger_text_3m, side=3, line=0.5, adj=0, cex=0.9, col="black")
```

## 2.3 Short-term effects on alcohol craving

The final part of the primary analysis will be conducted on alcohol craving.
We still need to use the excel-dataset "Extracted Clinical Outcome Data", but this time we import the sheet named "Craving" and assign row numbers for an easier sorting of the studies.

```{r importing-crav-3m-data, echo=TRUE, message=FALSE, warning=FALSE, include=TRUE}
# Import data on reduction as "crav_d" and preserve original order of studies
crav_d <- read_excel(osf_clinical_files$local_path, sheet = "Craving") %>% 
  mutate(row_id = row_number())
```

### 2.3.1 Calculation of effect sizes for continuous outcomes

For the primary analysis on alcohol reduction, we still want to focus on the time point "0-3 months", so we filter the data set by time point and re-arrange the studies in terms of alphabetical order.

```{r crav-3m-filter, echo=TRUE, message=FALSE, warning=FALSE, include=TRUE}
# Filter 0â€“3 month data and arrange specific studies first
crav_d_3m <- crav_d %>%
  filter(time_point == "0-3 months") %>%
  arrange(desc(study == "3a_dubuson_2021"),
          desc(study == "5f_garfield_2022"),
          desc(study == "8b_kvamme_2019"),
          desc(study == "10b_laurens_2023"),
          desc(study == "11_manning_2016"),
          desc(study == "16a_schoenmakers_2010"),
          desc(study == "17b_stein_2023"),
          desc(study == "2a_uyl_2018"),
          desc(study == "18a_wiers_2011")
  )
```

As we only have continuous data for alcohol craving, we only need to run the metacont()-function on our dataset to calculate the SMDs using Hedge's *g* correction.

```{r crav-3m-metacont, echo=TRUE, message=FALSE, warning=FALSE, include=TRUE}
# Calculating the SMDs (Hedge's g) using metacont()
crav_metacont_3m <- metacont(
  n.e = e_n,
  mean.e = e_crav_mean,
  sd.e = e_crav_sd,
  n.c = c_n,
  mean.c = c_crav_mean,
  sd.c = c_crav_sd,
  studlab = study,
  data = crav_d_3m,
  sm = "SMD",
  method.smd = "Hedges",
  method.tau = "REML",
  method.random.ci = "classic",
  random = TRUE
)
```

Now we can combine the calculated effect sizes and add them to the original data set without changing the original variable names.

```{r crav-3m-combined, echo=TRUE, message=FALSE, warning=FALSE, include=TRUE}
# Combine the SMDs calculated with original variables and store it in a new data frame
crav_d_full_3m <- data.frame(
  row_id = crav_d_3m$row_id,
  study = crav_metacont_3m$studlab,
  time_point = crav_d_3m$time_point,
  super_domain = crav_d_3m$super_domain,
  cog_domain = crav_d_3m$cog_domain,
  total_n = crav_d_3m$e_n + crav_d_3m$c_n, # Calculating total number of participants
  c_n = crav_d_3m$c_n,
  c_crav_mean = crav_d_3m$c_crav_mean,
  c_crav_sd = crav_d_3m$c_crav_sd,
  e_n = crav_d_3m$e_n,
  e_crav_mean = crav_d_3m$e_crav_mean,
  e_crav_sd = crav_d_3m$e_crav_sd,
  # Adding calculated SMDs to the dataframe 
  SMD = crav_metacont_3m$TE,
  SE = crav_metacont_3m$seTE,
  LCI = crav_metacont_3m$lower,
  UCI = crav_metacont_3m$upper,
  # Adding the z- and p-values
  `z-value` = crav_metacont_3m$TE / crav_metacont_3m$seTE,
  `p-value` = 2 * (1 - pnorm(abs(crav_metacont_3m$TE / crav_metacont_3m$seTE))),
  # Adding a final note on how data was converted    
  Notes = "Calculated using metacont()",
  check.names = FALSE # Removing the period as a space
)
```

### 2.3.2 Meta-analysis on alcohol craving

After we have calculated the effect sizes and added them to the original data set, we can now assign the previously defined study labels to the data set.

```{r crav-3m-assign-labels, echo=TRUE, message=FALSE, warning=FALSE, include=TRUE}
# Assign the new study labels to the combined data frame
crav_d_full_3m$study <- ifelse(crav_d_full_3m$study %in% names(study_labels),
                            study_labels[crav_d_full_3m$study],
                            crav_d_full_3m$study)
```

It is now possible to run the meta-analysis for alcohol craving using the metagen() function, setting the Hedges *g* correction for the SMD and REML for the heterogeneity analysisl.
However, as no study examined the effects of explicit cognitive training on alcohol craving, we do not apply stratification by subgroups.

```{r crav-3m-metagen, echo=TRUE, message=FALSE, warning=FALSE, include=TRUE}
# Run the meta-analysis stratified by superordinate domains and using the new labels
crav_metagen_3m <- metagen(TE = SMD,
                    seTE = SE,
                    studlab = study,
                    data = crav_d_full_3m,
                    sm = "SMD",
                    method.smd = "Hedges",
                    method.tau = "REML",
                    common = FALSE,
                    random = TRUE,
                    method.random.ci = "classic")

# Print the results of the meta-analysis
print(crav_metagen_3m)
```

The test statistics can now be extracted from the meta-analysis and stored as a data frame for the forest plot.

```{r crav-3m-zp-values, echo=TRUE, message=FALSE, warning=FALSE, include=TRUE}
# Extract the test statistics for the overall effect and create a data frame
crav_zp_over_3m <- data.frame(
  SMD = crav_metagen_3m$TE.random,
  SE = crav_metagen_3m$seTE.random,
  z_value = crav_metagen_3m$statistic.random,
  p_value = crav_metagen_3m$pval.random
)
```

With the test statistics stored as a data frame, we now turn to creating the forest plot, which follows the same design as previously used, however, no subgroup labels will be present, as only effects of implicit cognitive training on reduction was examined by the identified studies.

```{r crav-3m-forest, fig.height=6, fig.width=11, echo=TRUE, message=FALSE, warning=FALSE, include=TRUE, fig.cap="Forest plot of the effects on craving"}
# Now plot the forest plot again with new subgroup names
forest(crav_metagen_3m,
       prediction = TRUE,
       layout = "BMJ",
       overall = TRUE,
       random = TRUE,
       common = FALSE,
       print.stat = FALSE,
       print.I2 = TRUE,
       print.Q = TRUE,
       print.pval.Q = TRUE,
       print.tau2 = FALSE,
       label.left = "Favors Control",
       label.right = "Favors Intervention",
       spacing = 1.2,
       fontsize = 10,
       digits = 2,
       leftcols = c("studlab", "e_n", "e_crav_mean", "e_crav_sd", "c_n", "c_crav_mean",
                    "c_crav_sd"),
       leftlabs = c("Study", "Intv. (n)", "Mean", "SD", 
                    "Ctrl. (n)", "Mean", "SD"),
       just.addcols = "center"
       )

# Add a footer combining the test statistics for the overall effect
footer_over_crav_3m <- paste0(
  "Overall effect: ",
  paste0(
    "z = ", round(crav_zp_over_3m$z_value, 2),
    ", p = ", formatC(crav_zp_over_3m$p_value, digits = 2),
    collapse = "; "
  )
)

# Adjust the footer for the overall effect to the bottom left
grid.text(footer_over_crav_3m, x = 0.0195, y = 0.15,
          just = "left", gp = gpar(fontsize = 9))
```

### 2.3.3 Publication bias for short-term effects on craving

The final step for the primary analyses on alcohol craving, is to assess the publication bias of the included studies.
We can reuse the meta-analyses conducted in the section above for the funnel plot.
Instead, we need to run a Egger's test, but due to a low number of studies, we need to set the minimum *k* to eight studies.
The results will, however, be less reliable given the small number of studies, and interpretation of the results should be cautioned.

```{r crav-3m-eggers-test, echo=TRUE, message=FALSE, warning=FALSE, include=TRUE}
# Conduct an Egger's test using the previously calculated treatment effects
crav_egger_3m <- metabias(crav_metagen_3m, method.bias = "Egger", k.min = 8)

# Print the results of the Egger's test
print(crav_egger_3m)
```

Now with the results from the Egger's test, we can now create the funnel plot using the meta-package inbuilt function funnel().
We can add the test statistic from the Egger's test to the funnel plot using mtext().
As there is a high variability among these studies, we will need to adjust the limits of the x-axis so the studies can be better displayed.

```{r crav-3m-funnel-plot, fig.height=8, fig.width=8, message=FALSE, warning=FALSE, include=TRUE, fig.cap="Funnel plot of the studies on short-term effects on craving"}
# Calculate limits for x-axis to center the funnel
smd_summary <- crav_metagen_3m$TE.random  # or TE.fixed if preferred
xlim_range <- max(abs(crav_metagen_3m$TE - smd_summary)) + 0.5
xlim <- c(smd_summary - xlim_range, smd_summary + xlim_range)

# Create a funnel plot with adjusted x-axis
funnel(crav_metagen_3m,
       xlab = "Standardised Mean Difference",
       studlab = TRUE,
       pch = 17,
       cex = 1,
       xlim = xlim)

# Add Egger's test statistic to the plot
crav_egger_text_3m <- paste0("Egger's test: p = ", 
                     round(crav_egger_3m$p.value, 3))

# Define the actual placement of the statistics on the funnel plot
mtext(crav_egger_text_3m, side=3, line=0.5, adj=0, cex=0.9, col="black")
```

# 3. Secondary analyses on short-term effects for subordinate domains (0-3 months)

The secondary analyses on short-term effects of cognitive training, will follow the same procedure and pool the effects for each of the specified outcomes, but this time they will be stratified by the subordinate cognitive domains targeted by each training program.
We will still use the previously defined data frames for each of the outcomes and conduct the analyses with the new stratification.

## 3.1 Short-term effects on continuous abstinence by subgroups

To explore the short-term effects on CA by each subordinate domain, we first need to assign new variable names to the subgroups to create a visually more appealing forest plot.
We assign labels to four subordinate domains: Executive functions (Explicit cognition), Approach bias (Implicit cognition), Attentional bias (Implicit cognition), and Inhibitory bias (Implicit cognition).

```{r ca-sec-3m-rename-subgroups, echo=TRUE, message=FALSE, warning=FALSE, include=TRUE}
# Assigning new variable names to the subgroups
ca_d_full_3m <- ca_d_full_3m %>%
  dplyr::rename(super_domain = Subgroup) %>%
  dplyr::rename(Subgroup = cog_domain) %>%
  dplyr::mutate(
    Subgroup = factor(
      Subgroup,
      levels = c("Executive functions", "Approach bias", "Attentional bias", "Inhibitory bias")
    )
  )
```

### 3.1.1 Meta-analysis on continuous abstinence

Now with the newly defined subgroup labels, we can conduct the meta-analysis using metagen(), but this time set the parameter for subgroups to the label "Subgroup" and use the classic *z*-test for the random effects model.

```{r ca-sec-3m-metagen, echo=TRUE, message=FALSE, warning=FALSE, include=TRUE}
# Run the meta-analysis stratified by superordinate domains and using the new labels
ca_sec_metagen_3m <- metagen(TE = lnOR,
                    seTE = SElnOR,
                    studlab = study,
                    data = ca_d_full_3m,
                    subgroup = Subgroup,
                    sm = "OR",
                    method.tau = "REML",
                    common = FALSE,
                    random = TRUE,
                    method.random.ci = "classic")

# Print the results of the meta-analysis
print(ca_sec_metagen_3m)
```

It is now possible to extract the test statistics for the overall and subgroup effects, which can be used for the forest plot.

```{r ca-sec-3m-zp-values, echo=TRUE, message=FALSE, warning=FALSE, include=TRUE}
# Extract the test statistics for the overall effect and create a data frame
ca_sec_zp_overall_3m <- data.frame(
  lnOR = ca_sec_metagen_3m$TE.random,
  lnOR_se = ca_sec_metagen_3m$seTE.random,
  z_value = ca_sec_metagen_3m$statistic.random,
  p_value = ca_sec_metagen_3m$pval.random
)

# Extract the test statistics for the subgroup analysis and create a data frame
ca_sec_zp_subgroup_3m <- data.frame(
  subgroup = ca_sec_metagen_3m$bylevs,
  lnOR = ca_sec_metagen_3m$TE.random.w,
  lnOR_se = ca_sec_metagen_3m$seTE.random.w,
  z_value = ca_sec_metagen_3m$statistic.random.w,
  p_value = ca_sec_metagen_3m$pval.random.w
)
```

For an easier way to add the individual effect sizes for each subgroup in the final forest plot, we can create a split of the data frame.

```{r ca-sec-3m-subgroup-split, echo=TRUE, message=FALSE, warning=FALSE, include=TRUE}
# Split the previously defined data frame by each subordinate domain
ca_sec_subsplit_3m <- split(ca_sec_zp_subgroup_3m, ca_sec_zp_subgroup_3m$subgroup)
```

Now that we have created a list for the test statistics for each of the subordinate domains, we can create the final forest plot.

```{r ca-sec-3m-forest, fig.height=9, fig.width=12, message=FALSE, warning=FALSE, include=TRUE, fig.cap="Forest plot of the effects of individual subordinate domains on abstinence"}
# Now plot the forest plot again with new subgroup names
forest(ca_sec_metagen_3m,
       prediction = TRUE,
       prediction.subgroup = TRUE,
       layout = "BMJ",
       subgroup = TRUE,
       overall = TRUE,
       random = TRUE,
       common = FALSE,
       test.subgroup = FALSE,
       print.stat = FALSE,
       print.I2 = TRUE,
       print.Q = TRUE,
       print.pval.Q = TRUE,
       print.tau2 = FALSE,
       label.left = "Favors Control",
       label.right = "Favors Intervention",
       spacing = 1.2,
       fontsize = 10,
       digits = 2,
       leftcols = c("studlab", "e_abs", "e_n", "c_abs", "c_n"),
       leftlabs = c("Study", "Intv. (events)", "Total (n)", 
                    "Ctrl. (events)", "Total (n)"),
       just.addcols = "center"
       )

# Add a footer for the test statistics of the effects for executive functions
footer_sec_exft_ca_3m <- paste0(
  "Subgroup effect | ",
  paste0(
    ca_sec_subsplit_3m$`Executive functions`,
    ": z = ", round(ca_sec_subsplit_3m$`Executive functions`$z_value, 2),
    ", p = ", formatC(ca_sec_subsplit_3m$`Executive functions`$p_value, digits = 2)
  )
)

# Add a footer for the test statistics of the effects for approach bias
footer_sec_apbm_ca_3m <- paste0(
  "Subgroup effect | ",
  paste0(
    ca_sec_subsplit_3m$`Approach bias`,
    ": z = ", round(ca_sec_subsplit_3m$`Approach bias`$z_value, 2),
    ", p = ", formatC(ca_sec_subsplit_3m$`Approach bias`$p_value, digits = 2)
  )
)

# Add a footer for the test statistics of the effects for attentional bias
footer_sec_atbm_ca_3m <- paste0(
  "Subgroup effect | ",
  paste0(
    ca_sec_subsplit_3m$`Attentional bias`,
    ": z = ", round(ca_sec_subsplit_3m$`Attentional bias`$z_value, 2),
    ", p = ", formatC(ca_sec_subsplit_3m$`Attentional bias`$p_value, digits = 2)
  )
)

# Add a footer for the test statistics of the effects for inhibitory bias
footer_sec_itbm_ca_3m <- paste0(
  "Subgroup effect | ",
  paste0(
    ca_sec_subsplit_3m$`Inhibitory bias`,
    ": z = ", round(ca_sec_subsplit_3m$`Inhibitory bias`$z_value, 2),
    ", p = ", formatC(ca_sec_subsplit_3m$`Inhibitory bias`$p_value, digits = 2)
  )
)

# Add a footer combining the test statistics for the overall effect
footer_sec_over_ca_3m <- paste0(
  "Overall effect: ",
  paste0(
    "z = ", round(ca_sec_zp_overall_3m$z_value, 2),
    ", p = ", formatC(ca_sec_zp_overall_3m$p_value, digits = 2),
    collapse = "; "
  )
)

# Adjust the footer for the executive functions right below the subgroup
grid.text(footer_sec_exft_ca_3m, x = 0.091, y = 0.805,
          just = "left", gp = gpar(fontsize = 8))

# Adjust the footer for the approach bias right below the subgroup
grid.text(footer_sec_apbm_ca_3m, x = 0.091, y = 0.57,
          just = "left", gp = gpar(fontsize = 8))

# Adjust the footer for the attentional bias right below the subgroup
grid.text(footer_sec_atbm_ca_3m, x = 0.091, y = 0.378,
          just = "left", gp = gpar(fontsize = 8))

# Adjust the footer for the inhibitory bias right below the subgroup
grid.text(footer_sec_itbm_ca_3m, x = 0.091, y = 0.145,
          just = "left", gp = gpar(fontsize = 8))

# Adjust the footer for the overall effect to the bottom left
grid.text(footer_sec_over_ca_3m, x = 0.090, y = 0.025,
          just = "left", gp = gpar(fontsize = 9))
```

## 3.2 Short-term effects on alcohol reduction by subgroups

As only approach bias modification programs were used among the identified studies, we do not need to re-run the analyses using a new subgroup parameter, and we can simply use the results in section 2.2.
However, to add the option for applying subgroup labels or to quicly re-run the analyses with potentially new studies, we paste the procedure from section 2.2.

### 3.2.1 Meta-analysis on alcohol reduction

It is now possible to run the meta-analysis for alcohol reduction using the metagen() function, setting the Hedges *g* correction for the SMD and REML for the heterogeneity analysis.

```{r red-sec-3m-metagen, echo=TRUE, message=FALSE, warning=FALSE, include=TRUE}
# Run the meta-analysis stratified by superordinate domains and using the new labels
red_sec_metagen_3m <- metagen(TE = SMD,
                    seTE = SE,
                    studlab = study,
                    data = red_d_full_3m,
                    sm = "SMD",
                    method.smd = "Hedges",
                    method.tau = "REML",
                    common = FALSE,
                    random = TRUE,
                    method.random.ci = "classic")

# Print the results of the meta-analysis
print(red_sec_metagen_3m)
```

The test statistics can now be extracted from the meta-analysis and stored as a data frame for the forest plot.

```{r red-sec-3m-zp-values, echo=TRUE, message=FALSE, warning=FALSE, include=TRUE}
# Extract the test statistics for the overall effect and create a data frame
red_zp_over_3m <- data.frame(
  SMD = red_sec_metagen_3m$TE.random,
  SE = red_sec_metagen_3m$seTE.random,
  z_value = red_sec_metagen_3m$statistic.random,
  p_value = red_sec_metagen_3m$pval.random
)
```

With the test statistics stored as a data frame, we now turn to creating the forest plot, which follows the same design as previously used.

```{r red-sec-3m-forest, fig.height=6, fig.width=11, echo=TRUE, message=FALSE, warning=FALSE, include=TRUE, fig.cap="Forest plot of the effects of ApBM on alcohol reduction"}
# Now plot the forest plot again with new subgroup names
forest(red_sec_metagen_3m,
       prediction = TRUE,
       layout = "BMJ",
       overall = TRUE,
       random = TRUE,
       common = FALSE,
       print.stat = FALSE,
       print.I2 = TRUE,
       print.Q = TRUE,
       print.pval.Q = TRUE,
       print.tau2 = FALSE,
       label.left = "Favors Control",
       label.right = "Favors Intervention",
       spacing = 1.2,
       fontsize = 10,
       digits = 2,
       leftcols = c("studlab", "e_n", "e_reduc_mean", "e_reduc_sd", "c_n", "c_reduc_mean",
                    "c_reduc_sd"),
       leftlabs = c("Study", "Intv. (n)", "Mean", "SD", 
                    "Ctrl. (n)", "Mean", "SD"),
       just.addcols = "center"
       )

# Add a footer combining the test statistics for the overall effect
footer_sec_over_red_3m <- paste0(
  "Overall effect: ",
  paste0(
    "z = ", round(red_zp_over_3m$z_value, 2),
    ", p = ", formatC(red_zp_over_3m$p_value, digits = 2),
    collapse = "; "
  )
)

# Adjust the footer for the overall effect to the bottom left
grid.text(footer_sec_over_red_3m, x = 0.0385, y = 0.25,
          just = "left", gp = gpar(fontsize = 9))
```

## 3.3 Short-term effects on alcohol craving by subgroups

To explore the short-term effects on alcohol craving by each subordinate domain, we first need to assign new variable names to the subgroups to create a visually more appealing forest plot.
We assign labels to three subordinate domains: Approach bias (Implicit cognition), Attentional bias (Implicit cognition), and Inhibitory bias (Implicit cognition).

```{r crav-sec-3m-rename-subgroups, echo=TRUE, message=FALSE, warning=FALSE, include=TRUE}
# Assigning new variable names to the subgroups
crav_d_full_3m <- crav_d_full_3m %>%
  dplyr::rename(Subgroup = cog_domain) %>%
  dplyr::mutate(
    Subgroup = factor(
      Subgroup,
      levels = c("Approach bias", "Attentional bias", "Inhibitory bias")
    )
  )
```

### 3.3.1 Meta-analysis on alcohol craving

Now with the newly defined subgroup labels, we can conduct the meta-analysis using metagen(), but this time set the parameter for subgroups to the label "Subgroup" and use the classic *z*-test for the random effects model.

```{r crav-sec-3m-metagen, echo=TRUE, message=FALSE, warning=FALSE, include=TRUE}
# Run the meta-analysis stratified by superordinate domains and using the new labels
crav_sec_metagen_3m <- metagen(TE = SMD,
                    seTE = SE,
                    studlab = study,
                    data = crav_d_full_3m,
                    subgroup = Subgroup,
                    sm = "SMD",
                    method.tau = "REML",
                    common = FALSE,
                    random = TRUE,
                    method.random.ci = "classic")

# Print the results of the meta-analysis
print(crav_sec_metagen_3m)
```

It is now possible to extract the test statistics for the overall and subgroup effects, which can be used for the forest plot.

```{r crav-sec-3m-zp-values, echo=TRUE, message=FALSE, warning=FALSE, include=TRUE}
# Extract the test statistics for the overall effect and create a data frame
crav_sec_zp_overall_3m <- data.frame(
  SMD = crav_sec_metagen_3m$TE.random,
  SE = crav_sec_metagen_3m$seTE.random,
  z_value = crav_sec_metagen_3m$statistic.random,
  p_value = crav_sec_metagen_3m$pval.random
)

# Extract the test statistics for the subgroup analysis and create a data frame
crav_sec_zp_subgroup_3m <- data.frame(
  subgroup = crav_sec_metagen_3m$bylevs,
  SMD = crav_sec_metagen_3m$TE.random.w,
  SE = crav_sec_metagen_3m$seTE.random.w,
  z_value = crav_sec_metagen_3m$statistic.random.w,
  p_value = crav_sec_metagen_3m$pval.random.w
)
```

For an easier way to add the individual effect sizes for each subgroup in the final forest plot, we can create a split of the data frame.

```{r crav-sec-3m-subgroup-split, echo=TRUE, message=FALSE, warning=FALSE, include=TRUE}
# Split the previously defined data frame by each subordinate domain
crav_sec_subsplit_3m <- split(crav_sec_zp_subgroup_3m, crav_sec_zp_subgroup_3m$subgroup)
```

Now that we have created a list for the test statistics for each of the subordinate domains, we can create the final forest plot.

```{r crav-sec-3m-forest, fig.height=9, fig.width=12, message=FALSE, warning=FALSE, include=TRUE, fig.cap="Forest plot of the effects of individual subordinate domains on craving"}
# Now plot the forest plot again with new subgroup names
forest(crav_sec_metagen_3m,
       prediction = TRUE,
       prediction.subgroup = TRUE,
       layout = "BMJ",
       subgroup = TRUE,
       overall = TRUE,
       random = TRUE,
       common = FALSE,
       test.subgroup = FALSE,
       print.stat = FALSE,
       print.I2 = TRUE,
       print.Q = TRUE,
       print.pval.Q = TRUE,
       print.tau2 = FALSE,
       label.left = "Favors Control",
       label.right = "Favors Intervention",
       spacing = 1.2,
       fontsize = 10,
       digits = 2,
       leftcols = c("studlab", "e_n", "e_crav_mean", "e_crav_sd", "c_n", "c_crav_mean",
                    "c_crav_sd"),
       leftlabs = c("Study", "Intv. (n)", "Mean", "SD", 
                    "Ctrl. (n)", "Mean", "SD"),
       just.addcols = "center"
       )

# Add a footer for the test statistics of the effects for approach bias
footer_sec_apbm_crav_3m <- paste0(
  "Subgroup effect | ",
  paste0(
    crav_sec_subsplit_3m$`Approach bias`,
    ": z = ", round(crav_sec_subsplit_3m$`Approach bias`$z_value, 2),
    ", p = ", formatC(crav_sec_subsplit_3m$`Approach bias`$p_value, digits = 2)
  )
)

# Add a footer for the test statistics of the effects for attentional bias
footer_sec_atbm_crav_3m <- paste0(
  "Subgroup effect | ",
  paste0(
    crav_sec_subsplit_3m$`Attentional bias`,
    ": z = ", round(crav_sec_subsplit_3m$`Attentional bias`$z_value, 2),
    ", p = ", formatC(crav_sec_subsplit_3m$`Attentional bias`$p_value, digits = 2)
  )
)

# Add a footer for the test statistics of the effects for inhibitory bias
footer_sec_itbm_crav_3m <- paste0(
  "Subgroup effect | ",
  paste0(
    crav_sec_subsplit_3m$`Inhibitory bias`,
    ": z = ", round(crav_sec_subsplit_3m$`Inhibitory bias`$z_value, 2),
    ", p = ", formatC(crav_sec_subsplit_3m$`Inhibitory bias`$p_value, digits = 2)
  )
)

# Add a footer combining the test statistics for the overall effect
footer_sec_over_crav_3m <- paste0(
  "Overall effect: ",
  paste0(
    "z = ", round(crav_sec_zp_overall_3m$z_value, 2),
    ", p = ", formatC(crav_sec_zp_overall_3m$p_value, digits = 2),
    collapse = "; "
  )
)

# Adjust the footer for the approach bias right below the subgroup
grid.text(footer_sec_apbm_crav_3m, x = 0.06, y = 0.6,
          just = "left", gp = gpar(fontsize = 8))

# Adjust the footer for the attentional bias right below the subgroup
grid.text(footer_sec_atbm_crav_3m, x = 0.06, y = 0.378,
          just = "left", gp = gpar(fontsize = 8))

# Adjust the footer for the inhibitory bias right below the subgroup
grid.text(footer_sec_itbm_crav_3m, x = 0.06, y = 0.20,
          just = "left", gp = gpar(fontsize = 8))

# Adjust the footer for the overall effect to the bottom left
grid.text(footer_sec_over_crav_3m, x = 0.06, y = 0.075,
          just = "left", gp = gpar(fontsize = 9))
```

# 4. Tertiary analyses on intermediate and long-term effects (6 and 12 months)

The final part of the analyses will be conducted on the intermediate and long-term time points to explore for potential differential effects of cognitive training over time and to see how the effects compare to the results for the 0-3 month time point.
Intermediate effects will consist of studies examining cognitive training effects six months after intervention/discharge, whereas the analyses on the long-term effects will consist of studies exploring the effects 12 months after discharge.
We still use the excel-dataset "Extracted Clinical Outcome Data", but this time we will only be filtering the data sheets by time point for the calculation of effect sizes and not when conducting the meta-analyses

## 4.1 Intermediate and long-term effects on continuous abstinence

The first part of our tertiary analyses will be conducted on our primary outcome of CA, and we calculate the effect sizes for both the intermediate and long-term time point.

### 4.1.1 Calculation of effect sizes for intermediate continuous and categorical variables

We want to follow the procedure of converting the continuous variables to categorical outcomes and vice versa as mentioned in section 2.1.2 and 2.1.3, and to begin with we only do this for the intermediate time point.

```{r ca-6m-filter, echo=TRUE, message=FALSE, warning=FALSE, include=TRUE}
# Filter 6 month data first and store it as a new subset
ca_d_6m <- ca_d %>% filter(time_point == "6 months")
```

The calculation of effect sizes will be done by the inbuilt functions in the meta-package, so for the categorical variables, we will use the metabin() function.

```{r ca-6m-metabin, echo=TRUE, message=FALSE, warning=FALSE, include=TRUE}
# Calculating the lnORs using metabin()
ca_metabin_6m <- metabin(
  event.e = e_abs,
  n.e = e_n,
  event.c = c_abs,
  n.c = c_n,
  studlab = study,
  data = ca_d_6m,
  sm = "OR",
  method.tau = "REML",
  method.random.ci = "classic",
  random = TRUE,
  incr = 0.5,
  allstudies = TRUE
)
```

After we have calculated the lnORs, we can create a new data frame and store these values alongside with the other relevant variables (e.g., time point, number of abstinents, etc.) from our original dataset.
As performed previously, we calculate the ORs and SMDs using the Chinn-factor.
Finally, we add the z- and p-values to the data-frame.

```{r ca-6m-combined-data, echo=TRUE, message=FALSE, warning=FALSE, include=TRUE}
# Fetching the previously stored data frame and adding the lnORs, their SE and 95% CI
ca_d_full_6m <- data.frame(
  row_id = ca_d_6m$row_id,
  study = ca_metabin_6m$studlab,
  time_point = ca_d_6m$time_point,
  super_domain = ca_d_6m$super_domain,
  cog_domain = ca_d_6m$cog_domain,
  total_n = ca_d_6m$e_n + ca_d_6m$c_n,
  c_n = ca_d_6m$c_n,
  c_abs = ca_d_6m$c_abs,
  c_non_abs = ca_d_6m$c_n - ca_d_6m$c_abs,
  e_n = ca_d_6m$e_n,
  e_abs = ca_d_6m$e_abs,
  e_non_abs = ca_d_6m$e_n - ca_d_6m$e_abs,
# Extracting the lnORs from the metabin results
  lnOR = ca_metabin_6m$TE,
  SElnOR = ca_metabin_6m$seTE,
  lnLCI = ca_metabin_6m$lower,
  lnUCI = ca_metabin_6m$upper,
# Calculating the ORs from the metabin results
  OR = exp(ca_metabin_6m$TE),
  OrSE = exp(ca_metabin_6m$TE) * ca_metabin_6m$seTE,
  OrLCI = exp(ca_metabin_6m$lower),
  OrUCI = exp(ca_metabin_6m$upper),
# Caculating the SMD, SE and 95% CI using the Chinn-function
  SMD = ca_metabin_6m$TE * chinn_lnor_to_smd,
  SE = ca_metabin_6m$seTE * chinn_lnor_to_smd,
  LCI = ca_metabin_6m$lower * chinn_lnor_to_smd,
  UCI = ca_metabin_6m$upper * chinn_lnor_to_smd,
# Adding the z- and p-values
  `z-value` = ca_metabin_6m$TE / ca_metabin_6m$seTE,
  `p-value` = 2 * (1 - pnorm(abs(ca_metabin_6m$TE / ca_metabin_6m$seTE))),
# Adding a final note on how data was converted    
  Notes = "Continuous variables converted from categorical outcome (metabin) using Chinn's formula",
  check.names = FALSE
)
```

### 4.1.2 Calculation of effect sizes for long-term continuous and categorical variables

We can now apply the above methodology for our time point of 12 months, which requires us first to filter the data set.

```{r ca-12m-filter, echo=TRUE, message=FALSE, warning=FALSE, include=TRUE}
# Filter 12 month data first and store it as a new subset
ca_d_12m <- ca_d %>% filter(time_point == "12 months")
```

The calculation of effect sizes will be done by the inbuilt functions in the meta-package, so for the categorical variables, we will use the metabin() function.

```{r ca-12m-metabin, echo=TRUE, message=FALSE, warning=FALSE, include=TRUE}
# Calculating the lnORs using metabin()
ca_metabin_12m <- metabin(
  event.e = e_abs,
  n.e = e_n,
  event.c = c_abs,
  n.c = c_n,
  studlab = study,
  data = ca_d_12m,
  sm = "OR",
  method.tau = "REML",
  method.random.ci = "classic",
  random = TRUE,
  incr = 0.5,
  allstudies = TRUE
)
```

After we have calculated the lnORs, we can create a new data frame and store these values alongside with the other relevant variables (e.g., time point, number of abstinents, etc.) from our original dataset.
As performed previously, we calculate the ORs and SMDs using the Chinn-factor.
Finally, we add the z- and p-values to the data-frame.

```{r ca-12m-combined-data, echo=TRUE, message=FALSE, warning=FALSE, include=TRUE}
# Fetching the previously stored data frame and adding the lnORs, their SE and 95% CI
ca_d_full_12m <- data.frame(
  row_id = ca_d_12m$row_id,
  study = ca_metabin_12m$studlab,
  time_point = ca_d_12m$time_point,
  super_domain = ca_d_12m$super_domain,
  cog_domain = ca_d_12m$cog_domain,
  total_n = ca_d_12m$e_n + ca_d_12m$c_n,
  c_n = ca_d_12m$c_n,
  c_abs = ca_d_12m$c_abs,
  c_non_abs = ca_d_12m$c_n - ca_d_12m$c_abs,
  e_n = ca_d_12m$e_n,
  e_abs = ca_d_12m$e_abs,
  e_non_abs = ca_d_12m$e_n - ca_d_12m$e_abs,
# Extracting the lnORs from the metabin results
  lnOR = ca_metabin_12m$TE,
  SElnOR = ca_metabin_12m$seTE,
  lnLCI = ca_metabin_12m$lower,
  lnUCI = ca_metabin_12m$upper,
# Calculating the ORs from the metabin results
  OR = exp(ca_metabin_12m$TE),
  OrSE = exp(ca_metabin_12m$TE) * ca_metabin_12m$seTE,
  OrLCI = exp(ca_metabin_12m$lower),
  OrUCI = exp(ca_metabin_12m$upper),
# Caculating the SMD, SE and 95% CI using the Chinn-function
  SMD = ca_metabin_12m$TE * chinn_lnor_to_smd,
  SE = ca_metabin_12m$seTE * chinn_lnor_to_smd,
  LCI = ca_metabin_12m$lower * chinn_lnor_to_smd,
  UCI = ca_metabin_12m$upper * chinn_lnor_to_smd,
# Adding the z- and p-values
  `z-value` = ca_metabin_12m$TE / ca_metabin_12m$seTE,
  `p-value` = 2 * (1 - pnorm(abs(ca_metabin_12m$TE / ca_metabin_12m$seTE))),
# Adding a final note on how data was converted    
  Notes = "Continuous variables converted from categorical outcome (metabin) using Chinn's formula",
  check.names = FALSE
)
```

### 4.1.3 Integrating the data for continuous abstinence for all time points

First we need to assign old labels to the data frame for 0-3 months and ensure that the variables are numeric.

```{r ca-ter-rename-data, echo=TRUE, message=FALSE, warning=FALSE, include=TRUE}
# Assigning old variable names to the subgroups
ca_d_full_3m <- ca_d_full_3m %>%
  dplyr::rename(cog_domain = Subgroup) %>%
  dplyr::mutate( # Changing the order and label for the two subgroups
    super_domain = factor(super_domain,
                      levels = c("Explicit cognition", "Implicit cognition"),
                      labels = c("Explicit", "Implicit")))

# Converting to numeric values 
ca_d_full_3m <- ca_d_full_3m %>%
  dplyr::mutate(across(c(c_n, e_n, c_abs, e_abs, c_non_abs, e_non_abs, total_n),
                  ~ as.numeric(.)))
```

We can now integrate the two data frames with the data frame for 0-3 months using the the bind_rows function.

```{r ca-ter-combine-012m, echo=TRUE, message=FALSE, warning=FALSE, include=TRUE}
# Combine the three data frames for CA on all time points and round all the values 5 decimals
ca_d_full_0_12m <- bind_rows(ca_d_full_3m, ca_d_full_6m, ca_d_full_12m) %>% mutate(across(where(is.numeric), ~ round(.x, 5))) %>%
  # Arrange the studies by their pre-defined row-numbers
  arrange(row_id)
```

To use the same author labels in APA-format across all studies and sub-studies, we need to apply the previously defined study labels to our integrated data set.

```{r ca-ter-assign-labels-012m}
# Assign the new study labels to the combined data frame
ca_d_full_0_12m$study <- ifelse(ca_d_full_0_12m$study %in% names(study_labels),
                            study_labels[ca_d_full_0_12m$study],
                            ca_d_full_0_12m$study)
```

### 4.1.4 Meta-analysis on intermediate and long-term effects on continuous abstinence

To prepare for the final forest plot we need to make some adjustments to the integrated data frame such as assigning NAs to empty values.
As we only have one study on explicit cognitive training, we will have to filter this study out, and proceed with the meta-analysis exclusively on implicit cognitive training.

```{r ca-ter-imp-012m-assign-nas, echo=TRUE, message=FALSE, warning=FALSE, include=TRUE}
# Assign NAs strings to studies with missing event data
ca_d_imp_0_12m <- ca_d_full_0_12m %>%
  mutate(across(c(e_abs, e_non_abs, e_n, c_abs, c_non_abs, c_n), ~ ifelse(is.na(.), "NA", as.character(.)))) %>%
  filter(study != "Kumar et al. (2019)") # Filter out Kumar et al. (2019)
```

To make it clearer in the final forest plot, we assign new variable names to the stratification by time point, and sort them with the earliest time point on top and all the studies alphabetically.

```{r ca-ter-imp-012m-rename-subgroups, echo=TRUE, message=FALSE, warning=FALSE, include=TRUE}
# Assigning new variable names to the subgroups
ca_d_imp_0_12m <- ca_d_imp_0_12m %>%
  dplyr::rename("Time point" = time_point) %>% # Renaming the time_point variable
  arrange(study) %>% # Arrange the studies alphabetically
  arrange(desc(`Time point` == "0-3 months"), # Arrange then by Time Point
          desc(`Time point` == "6 months"),
          desc(`Time point` == "12 months")
  )
```

Now with the newly defined subgroup labels, we can conduct the meta-analysis using metagen(), but this time set the parameter for subgroups to the label "Time point" and use the classic *z*-test for the random effects model.

```{r ca-ter-012m-metagen, echo=TRUE, message=FALSE, warning=FALSE, include=TRUE}
# Run the meta-analysis stratified by superordinate domains and using the new labels
ca_ter_metagen_0_12m <- metagen(TE = lnOR,
                    seTE = SElnOR,
                    studlab = study,
                    data = ca_d_imp_0_12m,
                    subgroup = `Time point`,
                    sm = "OR",
                    method.tau = "REML",
                    common = FALSE,
                    random = TRUE,
                    method.random.ci = "classic")

# Print the results of the meta-analysis
print(ca_ter_metagen_0_12m)
```

It is now possible to extract the test statistics for the individual time points, which can be used for the forest plot.

```{r ca-ter-imp-012m-zp-values, echo=TRUE, message=FALSE, warning=FALSE, include=TRUE}
# Extract the test statistics for the subgroup analysis and create a data frame
ca_ter_zp_subgroup_012m <- data.frame(
  subgroup = ca_ter_metagen_0_12m$bylevs,
  lnOR = ca_ter_metagen_0_12m$TE.random.w,
  lnOR_se = ca_ter_metagen_0_12m$seTE.random.w,
  z_value = ca_ter_metagen_0_12m$statistic.random.w,
  p_value = ca_ter_metagen_0_12m$pval.random.w
)
```

For an easier way to add the individual effect sizes for each subgroup in the final forest plot, we can create a split of the data frame.

```{r ca-ter-imp-012m-subgroup-split, echo=TRUE, message=FALSE, warning=FALSE, include=TRUE}
# Split the previously defined data frame by each subordinate domain
ca_ter_subsplit_012m <- split(ca_ter_zp_subgroup_012m, ca_ter_zp_subgroup_012m$subgroup)
```

Now that we have created a list for the test statistics for each of the time points, we can create the final forest plot.

```{r ca-ter-imp-012m-forest, fig.height=12, fig.width=12, message=FALSE, warning=FALSE, include=TRUE, fig.cap="Forest plot for the short-, intermediate-, and long-term effects on abstinence"}
# Now plot the forest plot again with new subgroup names
forest(ca_ter_metagen_0_12m,
       prediction = TRUE,
       prediction.subgroup = TRUE,
       layout = "BMJ",
       subgroup = TRUE,
       overall = FALSE,
       random = TRUE,
       common = FALSE,
       test.subgroup = FALSE,
       print.stat = FALSE,
       print.I2 = TRUE,
       print.Q = TRUE,
       print.pval.Q = TRUE,
       print.tau2 = FALSE,
       label.left = "Favors Control",
       label.right = "Favors Intervention",
       spacing = 1.2,
       fontsize = 10,
       digits = 2,
       leftcols = c("studlab", "e_abs", "e_n", "c_abs", "c_n"),
       leftlabs = c("Study", "Intv. (events)", "Total (n)", 
                    "Ctrl. (events)", "Total (n)"),
       just.addcols = "center"
       )

# Add a footer for the test statistics of the effects after 0-3 months
footer_ter_03_ca <- paste0(
  "Subgroup effect | ",
  paste0(
    ca_ter_subsplit_012m$`0-3 months`,
    ": z = ", round(ca_ter_subsplit_012m$`0-3 months`$z_value, 2),
    ", p = ", formatC(ca_ter_subsplit_012m$`0-3 months`$p_value, digits = 2)
  )
)

# Add a footer for the test statistics of the effects after 6 months
footer_ter_6_ca <- paste0(
  "Subgroup effect | ",
  paste0(
    ca_ter_subsplit_012m$`6 months`,
    ": z = ", round(ca_ter_subsplit_012m$`6 months`$z_value, 2),
    ", p = ", formatC(ca_ter_subsplit_012m$`6 months`$p_value, digits = 2)
  )
)

# Add a footer for the test statistics of the effects after 12 months
footer_ter_12_ca <- paste0(
  "Subgroup effect | ",
  paste0(
    ca_ter_subsplit_012m$`12 months`,
    ": z = ", round(ca_ter_subsplit_012m$`12 months`$z_value, 2),
    ", p = ", formatC(ca_ter_subsplit_012m$`12 months`$p_value, digits = 2)
  )
)

# Adjust the footer for the 0-3 month time point right below the subgroup
grid.text(footer_ter_03_ca, x = 0.114, y = 0.56,
          just = "left", gp = gpar(fontsize = 8))


# Adjust the footer for the 6 month time point right below the subgroup
grid.text(footer_ter_6_ca, x = 0.114, y = 0.3825,
          just = "left", gp = gpar(fontsize = 8))

# Cover up unwanted group heterogeneity statistics
grid.rect(
  x = 0.1,
  y = 0.1,
  width = 0.6,
  height = 0.02,
  gp = gpar(fill = "white", col = NA)
)

# Adjust the footer for the 12 month time point right below the subgroup
grid.text(footer_ter_12_ca, x = 0.114, y = 0.1,
          just = "left", gp = gpar(fontsize = 8))
```

### 4.1.5 Publication bias for intermediate effects on continuous abstinence

To assess for potential publication bias across all time points, we need to create a funnel plot for the studies assessing the intermediate effects.
Before the funnel plot can be created, we will be changing the author names to fit the APA-format using the previously defined study labels.
Finally, we want to filter out the study by Kumar et al. (2019), as it is not included in the tertiary analyses.

```{r ca-ter-6m-assign-labels}
# Assign the new study labels to the data frame
ca_d_full_6m$study <- ifelse(ca_d_full_6m$study %in% names(study_labels),
                            study_labels[ca_d_full_6m$study],
                            ca_d_full_6m$study)

# Filter out the study by Kumar et al. (2019)
ca_d_imp_6m <- ca_d_full_6m %>%   
  filter(study != "Kumar et al. (2019)")
```

After defining the new labels, we can run a separate meta-analysis on the intermediate time point.

```{r ca-ter-6m-metagen, echo=TRUE, message=FALSE, warning=FALSE, include=TRUE}
# Run the meta-analysis stratified by superordinate domains and using the new labels
ca_ter_metagen_6m <- metagen(TE = lnOR,
                    seTE = SElnOR,
                    studlab = study,
                    data = ca_d_imp_6m,
                    sm = "OR",
                    method.tau = "REML",
                    common = FALSE,
                    random = TRUE)
```

Now we can run an Egger's test, but due to a low number of studies, we need to set the minimum *k* to four studies.
The results will, however, be less reliable given the small number of studies, and interpretation of the results should be cautioned.

```{r ca-ter-6m-eggers-test, echo=TRUE, message=FALSE, warning=FALSE, include=TRUE}
# Conduct an Egger's test using the previously calculated treatment effects
ca_egger_6m <- metabias(ca_ter_metagen_6m, method.bias = "Egger", k.min = 4)

# Print the results of the Egger's test
print(ca_egger_6m)
```

Now with the results from the Egger's test, we can now create the funnel plot using the meta-package inbuilt function funnel().
We can add the test statistic from the Egger's test to the funnel plot using mtext().
As there is a high variability among these studies, we will need to adjust the limits of the x-axis so the studies can be better displayed.

```{r ca-ter-6m-funnel-plot, fig.height=8, fig.width=8, message=FALSE, warning=FALSE, include=TRUE, fig.cap="Funnel plot for studies with intermediate effects on abstinence"}
# Create a funnel plot with adjusted x-axis
funnel(ca_ter_metagen_6m,
       xlab = "Odds ratio",
       studlab = TRUE,
       pch = 17,
       cex = 1)

# Add Egger's test statistic to the plot
ca_egger_text_6m <- paste0("Egger's test: p = ", 
                     round(ca_egger_6m$p.value, 3))

# Define the actual placement of the statistics on the funnel plot
mtext(ca_egger_text_6m, side=3, line=0.5, adj=0, cex=0.9, col="black")
```

### 4.1.6 Publication bias for long-term effects on continuous abstinence

After we have created a funnel plot for the intermediate time point, we can now create a funnel plot for the studies assessing the long-term effects.
Before the funnel plot can be created, we will be changing the author names to fit the APA-format using the previously defined study labels.

```{r ca-ter-12m-assign-labels}
# Assign the new study labels to the data frame
ca_d_full_12m$study <- ifelse(ca_d_full_12m$study %in% names(study_labels),
                            study_labels[ca_d_full_12m$study],
                            ca_d_full_12m$study)
```

After defining the new labels, we can run a separate meta-analysis on the long-term time point.

```{r ca-ter-12m-metagen, echo=TRUE, message=FALSE, warning=FALSE, include=TRUE}
# Run the meta-analysis stratified by superordinate domains and using the new labels
ca_ter_metagen_12m <- metagen(TE = lnOR,
                    seTE = SElnOR,
                    studlab = study,
                    data = ca_d_full_12m,
                    sm = "OR",
                    method.tau = "REML",
                    common = FALSE,
                    random = TRUE)
```

Now we can run an Egger's test, but due to a low number of studies, we need to set the minimum *k* to eight studies.
The results will, however, be less reliable given the small number of studies, and interpretation of the results should be cautioned.

```{r ca-ter-12m-eggers-test, echo=TRUE, message=FALSE, warning=FALSE, include=TRUE}
# Conduct an Egger's test using the previously calculated treatment effects
ca_egger_12m <- metabias(ca_ter_metagen_12m, method.bias = "Egger", k.min = 8)

# Print the results of the Egger's test
print(ca_egger_12m)
```

Now with the results from the Egger's test, we can now create the funnel plot using the meta-package inbuilt function funnel().
We can add the test statistic from the Egger's test to the funnel plot using mtext().
As there is a high variability among these studies, we will need to adjust the limits of the x-axis so the studies can be better displayed.

```{r ca-ter-12m-funnel-plot, fig.height=8, fig.width=8, message=FALSE, warning=FALSE, include=TRUE, fig.cap="Funnel plot of studies with long-term effects on abstinence"}
# Create a funnel plot for the 12 month time point
funnel(ca_ter_metagen_12m,
       xlab = "Odds Ratio",
       studlab = TRUE,
       pch = 17,
       cex = 0.5)

# Add Egger's test statistic to the plot
ca_egger_text_12m <- paste0("Egger's test: p = ", 
                     round(ca_egger_12m$p.value, 3))

# Define the actual placement of the statistics on the funnel plot
mtext(ca_egger_text_12m, side=3, line=0.5, adj=0, cex=0.9, col="black")
```

## 4.2 Intermediate and long-term effects on alcohol reduction

The second part of our tertiary analyses will be conducted on our secondary outcome of alcohol reduction, and we calculate the effect sizes for both the intermediate and long-term time point.

### 4.2.1 Calculation of effect sizes for intermediate continuous and categorical variables

We want to follow the procedure of as in section 4.1.1 and filter the data by the time point "6 months".

```{r red-6m-filter, echo=TRUE, message=FALSE, warning=FALSE, include=TRUE}
# Filter 6 month data first and store it as a new subset
red_d_6m <- red_d %>% filter(time_point == "6 months")
```

As we only have continuous data for alcohol reduction, we only need to run the metacont() on our dataset to calculate the SMDs using Hedge's *g* correction.

```{r red-6m-metacont, echo=TRUE, message=FALSE, warning=FALSE, include=TRUE}
# Calculating the SMDs (Hedge's g) using metacont()
red_metacont_6m <- metacont(
  n.e = e_n,
  mean.e = e_reduc_mean,
  sd.e = e_reduc_sd,
  n.c = c_n,
  mean.c = c_reduc_mean,
  sd.c = c_reduc_sd,
  studlab = study,
  data = red_d_6m,
  sm = "SMD",
  method.smd = "Hedges",
  method.tau = "REML",
  method.random.ci = "classic",
  random = TRUE
)
```

Now we can combine the calculated effect sizes and add them to the original data set without changing the original variable names.

```{r red-6m-combined, echo=TRUE, message=FALSE, warning=FALSE, include=TRUE}
# Combine the SMDs calculated with original variables and store it in a new data frame
red_d_full_6m <- data.frame(
  row_id = red_d_6m$row_id,
  study = red_metacont_6m$studlab,
  time_point = red_d_6m$time_point,
  super_domain = red_d_6m$super_domain,
  cog_domain = red_d_6m$cog_domain,
  total_n = red_d_6m$e_n + red_d_6m$c_n, # Calculating total number of participants
  c_n = red_d_6m$c_n,
  c_reduc_mean = red_d_6m$c_reduc_mean,
  c_reduc_sd = red_d_6m$c_reduc_sd,
  e_n = red_d_6m$e_n,
  e_reduc_mean = red_d_6m$e_reduc_mean,
  e_reduc_sd = red_d_6m$e_reduc_sd,
  # Adding calculated SMDs to the dataframe 
  SMD = red_metacont_6m$TE,
  SE = red_metacont_6m$seTE,
  LCI = red_metacont_6m$lower,
  UCI = red_metacont_6m$upper,
  # Adding the z- and p-values
  `z-value` = red_metacont_6m$TE / red_metacont_6m$seTE,
  `p-value` = 2 * (1 - pnorm(abs(red_metacont_6m$TE / red_metacont_6m$seTE))),
  # Adding a final note on how data was converted    
  Notes = "Calculated using metacont()",
  check.names = FALSE # Removing the period as a space
)
```

### 4.2.2 Calculation of effect sizes for long-term continuous and categorical variables

We repeat the procedure as in the above section but this time filter the data by the time point "12 months".

```{r red-12m-filter, echo=TRUE, message=FALSE, warning=FALSE, include=TRUE}
# Filter 6 month data first and store it as a new subset
red_d_12m <- red_d %>% filter(time_point == "12 months")
```

As we only have continuous data for alcohol reduction, we only need to run the metacont() on our dataset to calculate the SMDs using Hedge's *g* correction.

```{r red-12m-metacont, echo=TRUE, message=FALSE, warning=FALSE, include=TRUE}
# Calculating the SMDs (Hedge's g) using metacont()
red_metacont_12m <- metacont(
  n.e = e_n,
  mean.e = e_reduc_mean,
  sd.e = e_reduc_sd,
  n.c = c_n,
  mean.c = c_reduc_mean,
  sd.c = c_reduc_sd,
  studlab = study,
  data = red_d_12m,
  sm = "SMD",
  method.smd = "Hedges",
  method.tau = "REML",
  method.random.ci = "classic",
  random = TRUE
)
```

Now we can combine the calculated effect sizes and add them to the original data set without changing the original variable names.

```{r red-12m-combined, echo=TRUE, message=FALSE, warning=FALSE, include=TRUE}
# Combine the SMDs calculated with original variables and store it in a new data frame
red_d_full_12m <- data.frame(
  row_id = red_d_12m$row_id,
  study = red_metacont_12m$studlab,
  time_point = red_d_12m$time_point,
  super_domain = red_d_12m$super_domain,
  cog_domain = red_d_12m$cog_domain,
  total_n = red_d_12m$e_n + red_d_12m$c_n, # Calculating total number of participants
  c_n = red_d_12m$c_n,
  c_reduc_mean = red_d_12m$c_reduc_mean,
  c_reduc_sd = red_d_12m$c_reduc_sd,
  e_n = red_d_12m$e_n,
  e_reduc_mean = red_d_12m$e_reduc_mean,
  e_reduc_sd = red_d_12m$e_reduc_sd,
  # Adding calculated SMDs to the dataframe 
  SMD = red_metacont_12m$TE,
  SE = red_metacont_12m$seTE,
  LCI = red_metacont_12m$lower,
  UCI = red_metacont_12m$upper,
  # Adding the z- and p-values
  `z-value` = red_metacont_12m$TE / red_metacont_12m$seTE,
  `p-value` = 2 * (1 - pnorm(abs(red_metacont_12m$TE / red_metacont_12m$seTE))),
  # Adding a final note on how data was converted    
  Notes = "Calculated using metacont()",
  check.names = FALSE # Removing the period as a space
)
```

### 4.2.3 Integrating the data for alcohol reduction for all time points

We can now integrate the two data frames with the data frame for 0-3 months using the the bind_rows function.

```{r red-ter-combine-012m, echo=TRUE, message=FALSE, warning=FALSE, include=TRUE}
# Combine the three data frames for craving on all time points and round all the values 5 decimals
red_d_full_0_12m <- bind_rows(red_d_full_3m, red_d_full_6m, red_d_full_12m) %>% mutate(across(where(is.numeric), ~ round(.x, 5))) %>%
  # Arrange the studies by their pre-defined row-numbers
  arrange(row_id)
```

To use the same author labels in APA-format across all studies and sub-studies, we need to apply the previously defined study labels to our integrated data set.

```{r red-ter-assign-labels-012m}
# Assign the new study labels to the combined data frame
red_d_full_0_12m$study <- ifelse(red_d_full_0_12m$study %in% names(study_labels),
                            study_labels[red_d_full_0_12m$study],
                            red_d_full_0_12m$study)
```

### 4.2.4 Meta-analysis on intermediate and long-term alcohol reduction

To make it clearer in the final forest plot, we assign new variable names to the stratification by time point, and sort them with the earliest time point on top.

```{r red-ter-012m-rename-subgroups, echo=TRUE, message=FALSE, warning=FALSE, include=TRUE}
# Assigning new variable names to the subgroups
red_d_full_0_12m <- red_d_full_0_12m %>%
  dplyr::rename("Time point" = time_point) %>% # Renaming the time_point variable
  arrange(study) %>% # Arrange the studies alphabetically
  arrange(desc(`Time point` == "0-3 months"), # Arrange then by Time Point
          desc(`Time point` == "6 months"),
          desc(`Time point` == "12 months")
  )
```

Now with the newly defined subgroup labels, we can conduct the meta-analysis using metagen(), but this time set the parameter for subgroups to the label "Time point" and use the classic *z*-test for the random effects model.

```{r red-ter-012m-metagen, echo=TRUE, message=FALSE, warning=FALSE, include=TRUE}
# Run the meta-analysis stratified by superordinate domains and using the new labels
red_ter_metagen_0_12m <- metagen(TE = SMD,
                    seTE = SE,
                    studlab = study,
                    data = red_d_full_0_12m,
                    subgroup = `Time point`,
                    sm = "SMD",
                    method.tau = "REML",
                    common = FALSE,
                    random = TRUE,
                    method.random.ci = "classic")

# Print the results of the meta-analysis
print(red_ter_metagen_0_12m)
```

It is now possible to extract the test statistics for the individual time points, which can be used for the forest plot.

```{r red-ter-012m-zp-values, echo=TRUE, message=FALSE, warning=FALSE, include=TRUE}
# Extract the test statistics for the subgroup analysis and create a data frame
red_ter_zp_subgroup_012m <- data.frame(
  subgroup = red_ter_metagen_0_12m$bylevs,
  SMD = red_ter_metagen_0_12m$TE.random.w,
  SE = red_ter_metagen_0_12m$seTE.random.w,
  z_value = red_ter_metagen_0_12m$statistic.random.w,
  p_value = red_ter_metagen_0_12m$pval.random.w
)
```

For an easier way to add the individual effect sizes for each subgroup in the final forest plot, we can create a split of the data frame.

```{r red-ter-012m-subgroup-split, echo=TRUE, message=FALSE, warning=FALSE, include=TRUE}
# Split the previously defined data frame by each subordinate domain
red_ter_subsplit_012m <- split(red_ter_zp_subgroup_012m, red_ter_zp_subgroup_012m$subgroup)
```

Now that we have created a list for the test statistics for each of the time points, we can create the final forest plot.
We set the overall effect to FALSE, as we do not want to pool the effects across reports of different time points in the same study.

```{r red-ter-012m-forest, fig.height=6, fig.width=11, message=FALSE, warning=FALSE, include=TRUE, fig.cap="Forest plot of short-, intermediate-, and long-term effects on alcohol reduction"}
# Now plot the forest plot again with new subgroup names
forest(red_ter_metagen_0_12m,
       prediction = TRUE,
       layout = "BMJ",
       overall = FALSE,
       subgroup = TRUE,
       random = TRUE,
       common = FALSE,
       test.subgroup = TRUE,
       print.stat = FALSE,
       print.I2 = TRUE,
       print.Q = TRUE,
       print.pval.Q = TRUE,
       print.tau2 = FALSE,
       label.left = "Favors Control",
       label.right = "Favors Intervention",
       spacing = 1.2,
       fontsize = 10,
       digits = 2,
       leftcols = c("studlab", "e_n", "e_reduc_mean", "e_reduc_sd", "c_n", "c_reduc_mean",
                    "c_reduc_sd"),
       leftlabs = c("Study", "Intv. (n)", "Mean", "SD", 
                    "Ctrl. (n)", "Mean", "SD"),
       just.addcols = "center"
       )


# Add a footer for the test statistics of the effects after 0-3 months
footer_ter_03_red <- paste0(
  "Subgroup effect | ",
  paste0(
    red_ter_subsplit_012m$`0-3 months`,
    ": z = ", round(red_ter_subsplit_012m$`0-3 months`$z_value, 2),
    ", p = ", formatC(red_ter_subsplit_012m$`0-3 months`$p_value, digits = 2)
  )
)

# Add a footer for the test statistics of the effects after 6 months
footer_ter_6_red <- paste0(
  "Subgroup effect | ",
  paste0(
    red_ter_subsplit_012m$`6 months`,
    ": z = ", round(red_ter_subsplit_012m$`6 months`$z_value, 2),
    ", p = ", formatC(red_ter_subsplit_012m$`6 months`$p_value, digits = 2)
  )
)

# Add a footer for the test statistics of the effects after 12 months
footer_ter_12_red <- paste0(
  "Subgroup effect | ",
  paste0(
    red_ter_subsplit_012m$`12 months`,
    ": z = ", round(red_ter_subsplit_012m$`12 months`$z_value, 2),
    ", p = ", formatC(red_ter_subsplit_012m$`12 months`$p_value, digits = 2)
  )
)

# Adjust the footer for the 0-3 month time point right below the subgroup
grid.text(footer_ter_03_red, x = 0.057, y = 0.52,
          just = "left", gp = gpar(fontsize = 8))


# Adjust the footer for the 6 month time point right below the subgroup
grid.text(footer_ter_6_red, x = 0.057, y = 0.25,
          just = "left", gp = gpar(fontsize = 8))

# Adjust the footer for the 12 month time point right below the subgroup
grid.text(footer_ter_12_red, x = 0.057, y = 0.05,
          just = "left", gp = gpar(fontsize = 8))
```

### 4.2.5 Publication bias for intermediate effects on alcohol reduction

We only identified three studies for the intermediate time point, which makes it less meaningful to inspect for visual asymmetry, however, we proceed with creating the plot.
First we will be changing the author names to fit the APA-format using the previously defined study labels.

```{r red-ter-6m-assign-labels}
# Assign the new study labels to the data frame
red_d_full_6m$study <- ifelse(red_d_full_6m$study %in% names(study_labels),
                            study_labels[red_d_full_6m$study],
                            red_d_full_6m$study)
```

After defining the new labels, we can run a separate meta-analysis on the long-term time point.

```{r red-ter-6m-metagen, echo=TRUE, message=FALSE, warning=FALSE, include=TRUE}
# Run the meta-analysis stratified by superordinate domains and using the new labels
red_ter_metagen_6m <- metagen(TE = SMD,
                    seTE = SE,
                    studlab = study,
                    data = red_d_full_6m,
                    sm = "SMD",
                    method.tau = "REML",
                    common = FALSE,
                    random = TRUE)
```

Though an Egger's test will not have the required statistical power, any interpretation of the results should be highly cautioned.
However, we proceed with conducting the test and adding it to the final plot.

```{r red-ter-6m-eggers-test, echo=TRUE, message=FALSE, warning=FALSE, include=TRUE}
# Conduct an Egger's test using the previously calculated treatment effects
ca_egger_6m <- metabias(ca_ter_metagen_6m, method.bias = "Egger", k.min = 2)

# Print the results of the Egger's test
print(ca_egger_6m)
```

We can now create the funnel plot and add the result of the Egger's test.

```{r red-ter-6m-funnel-plot, fig.height=8, fig.width=8, message=FALSE, warning=FALSE, include=TRUE, fig.cap="Funnel plot of studies with intermediate effects on alcohol reduction"}
# Create a funnel plot for the 6 month time point
funnel(red_ter_metagen_6m,
       xlab = "Standardised Mean Difference",
       studlab = TRUE,
       pch = 17,
       cex = 0.5)

# Add Egger's test statistic to the plot
ca_egger_text_6m <- paste0("Egger's test: p = ", 
                     round(ca_egger_6m$p.value, 3))

# Define the actual placement of the statistics on the funnel plot
mtext(ca_egger_text_6m, side=3, line=0.5, adj=0, cex=0.9, col="black")
```

### 4.2.6 Publication bias for long-term effects on alcohol reduction

As we only identified one study for the long-term time point, a visual inspection for asymmetry will not be meaningful nor will there be sufficient power for an Egger's test.

## 4.3 Intermediate and long-term effects on alcohol craving

The last part of our tertiary analyses will be conducted on alcohol craving, and we calculate the effect sizes for both the intermediate and long-term time point.

### 4.3.1 Calculation of effect sizes for intermediate continuous and categorical variables

We repeat the methodology used in section 4.2.1 and start with filtering the data for 6 months

```{r crav-6m-filter, echo=TRUE, message=FALSE, warning=FALSE, include=TRUE}
# Filter 6 month data first and store it as a new subset
crav_d_6m <- crav_d %>% filter(time_point == "6 months")
```

As we only have continuous data for alcohol craving, we only need to run the metacont()-function on our dataset to calculate the SMDs using Hedge's *g* correction.

```{r crav-6m-metacont, echo=TRUE, message=FALSE, warning=FALSE, include=TRUE}
# Calculating the SMDs (Hedge's g) using metacont()
crav_metacont_6m <- metacont(
  n.e = e_n,
  mean.e = e_crav_mean,
  sd.e = e_crav_sd,
  n.c = c_n,
  mean.c = c_crav_mean,
  sd.c = c_crav_sd,
  studlab = study,
  data = crav_d_6m,
  sm = "SMD",
  method.smd = "Hedges",
  method.tau = "REML",
  method.random.ci = "classic",
  random = TRUE
)
```

Now we can combine the calculated effect sizes and add them to the original data set without changing the original variable names.

```{r crav-6m-combined, echo=TRUE, message=FALSE, warning=FALSE, include=TRUE}
# Combine the SMDs calculated with original variables and store it in a new data frame
crav_d_full_6m <- data.frame(
  row_id = crav_d_6m$row_id,
  study = crav_metacont_6m$studlab,
  time_point = crav_d_6m$time_point,
  super_domain = crav_d_6m$super_domain,
  cog_domain = crav_d_6m$cog_domain,
  total_n = crav_d_6m$e_n + crav_d_6m$c_n, # Calculating total number of participants
  c_n = crav_d_6m$c_n,
  c_crav_mean = crav_d_6m$c_crav_mean,
  c_crav_sd = crav_d_6m$c_crav_sd,
  e_n = crav_d_6m$e_n,
  e_crav_mean = crav_d_6m$e_crav_mean,
  e_crav_sd = crav_d_6m$e_crav_sd,
  # Adding calculated SMDs to the dataframe 
  SMD = crav_metacont_6m$TE,
  SE = crav_metacont_6m$seTE,
  LCI = crav_metacont_6m$lower,
  UCI = crav_metacont_6m$upper,
  # Adding the z- and p-values
  `z-value` = crav_metacont_6m$TE / crav_metacont_6m$seTE,
  `p-value` = 2 * (1 - pnorm(abs(crav_metacont_6m$TE / crav_metacont_6m$seTE))),
  # Adding a final note on how data was converted    
  Notes = "Calculated using metacont()",
  check.names = FALSE # Removing the period as a space
)
```

### 4.3.2 Calculation of effect sizes for intermediate continuous and categorical variables

We repeat the methodology used in the section above but this time filter the data by "12 months"

```{r crav-12m-filter, echo=TRUE, message=FALSE, warning=FALSE, include=TRUE}
# Filter 6 month data first and store it as a new subset
crav_d_12m <- crav_d %>% filter(time_point == "12 months")
```

As we only have continuous data for alcohol craving, we only need to run the metacont()-function on our dataset to calculate the SMDs using Hedge's *g* correction.

```{r crav-12m-metacont, echo=TRUE, message=FALSE, warning=FALSE, include=TRUE}
# Calculating the SMDs (Hedge's g) using metacont()
crav_metacont_12m <- metacont(
  n.e = e_n,
  mean.e = e_crav_mean,
  sd.e = e_crav_sd,
  n.c = c_n,
  mean.c = c_crav_mean,
  sd.c = c_crav_sd,
  studlab = study,
  data = crav_d_12m,
  sm = "SMD",
  method.smd = "Hedges",
  method.tau = "REML",
  method.random.ci = "classic",
  random = TRUE
)
```

Now we can combine the calculated effect sizes and add them to the original data set without changing the original variable names.

```{r crav-12m-combined, echo=TRUE, message=FALSE, warning=FALSE, include=TRUE}
# Combine the SMDs calculated with original variables and store it in a new data frame
crav_d_full_12m <- data.frame(
  row_id = crav_d_12m$row_id,
  study = crav_metacont_12m$studlab,
  time_point = crav_d_12m$time_point,
  super_domain = crav_d_12m$super_domain,
  cog_domain = crav_d_12m$cog_domain,
  total_n = crav_d_12m$e_n + crav_d_12m$c_n, # Calculating total number of participants
  c_n = crav_d_12m$c_n,
  c_crav_mean = crav_d_12m$c_crav_mean,
  c_crav_sd = crav_d_12m$c_crav_sd,
  e_n = crav_d_12m$e_n,
  e_crav_mean = crav_d_12m$e_crav_mean,
  e_crav_sd = crav_d_12m$e_crav_sd,
  # Adding calculated SMDs to the dataframe 
  SMD = crav_metacont_12m$TE,
  SE = crav_metacont_12m$seTE,
  LCI = crav_metacont_12m$lower,
  UCI = crav_metacont_12m$upper,
  # Adding the z- and p-values
  `z-value` = crav_metacont_12m$TE / crav_metacont_12m$seTE,
  `p-value` = 2 * (1 - pnorm(abs(crav_metacont_12m$TE / crav_metacont_12m$seTE))),
  # Adding a final note on how data was converted    
  Notes = "Calculated using metacont()",
  check.names = FALSE # Removing the period as a space
)
```

### 4.3.3 Integrating the data for craving for all time points

Before we can integrate the data frames across all three time points, we need to assign the old variable name for "cognitive domain" to the data frame stored for 0-3 months.

```{r crav-ter-old-labels, echo=TRUE, message=FALSE, warning=FALSE, include=TRUE}
# Assigning old variable names to the subgroups
crav_d_full_3m <- crav_d_full_3m %>%
  dplyr::rename(cog_domain = Subgroup)
```

We can now integrate the two data frames with the data frame for 0-3 months using the the bind_rows function.

```{r crav-ter-combine-012m, echo=TRUE, message=FALSE, warning=FALSE, include=TRUE}
# Combine the three data frames for craving on all time points and round all the values 5 decimals
crav_d_full_0_12m <- bind_rows(crav_d_full_3m, crav_d_full_6m, crav_d_full_12m) %>% mutate(across(where(is.numeric), ~ round(.x, 5))) %>%
  # Arrange the studies by their pre-defined row-numbers
  arrange(row_id)
```

To use the same author labels in APA-format across all studies and sub-studies, we need to apply the previously defined study labels to our integrated data set.

```{r crav-ter-assign-labels-012m}
# Assign the new study labels to the combined data frame
crav_d_full_0_12m$study <- ifelse(crav_d_full_0_12m$study %in% names(study_labels),
                            study_labels[crav_d_full_0_12m$study],
                            crav_d_full_0_12m$study)
```

### 4.3.4 Meta-analysis on intermediate and long-term craving

To make it clearer in the final forest plot, we assign new variable names to the stratification by time point, and sort them with the earliest time point on top.

```{r crav-ter-012m-rename-subgroups, echo=TRUE, message=FALSE, warning=FALSE, include=TRUE}
# Assigning new variable names to the subgroups
crav_d_full_0_12m <- crav_d_full_0_12m %>%
  dplyr::rename("Time point" = time_point) %>% # Renaming the time_point variable
  arrange(study) %>% # Arrange the studies alphabetically
  arrange(desc(`Time point` == "0-3 months"), # Arrange then by Time Point
          desc(`Time point` == "6 months"),
          desc(`Time point` == "12 months")
  )
```

Now with the newly defined subgroup labels, we can conduct the meta-analysis using metagen(), but this time set the parameter for subgroups to the label "Time point" and use the classic *z*-test for the random effects model.

```{r crav-ter-012m-metagen, echo=TRUE, message=FALSE, warning=FALSE, include=TRUE}
# Run the meta-analysis stratified by superordinate domains and using the new labels
crav_ter_metagen_0_12m <- metagen(TE = SMD,
                    seTE = SE,
                    studlab = study,
                    data = crav_d_full_0_12m,
                    subgroup = `Time point`,
                    sm = "OR",
                    method.tau = "REML",
                    common = FALSE,
                    random = TRUE,
                    method.random.ci = "classic")

# Print the results of the meta-analysis
print(crav_ter_metagen_0_12m)
```

It is now possible to extract the test statistics for the individual time points, which can be used for the forest plot.

```{r crav-ter-012m-zp-values, echo=TRUE, message=FALSE, warning=FALSE, include=TRUE}
# Extract the test statistics for the subgroup analysis and create a data frame
crav_ter_zp_subgroup_012m <- data.frame(
  subgroup = crav_ter_metagen_0_12m$bylevs,
  SMD = crav_ter_metagen_0_12m$TE.random.w,
  SE = crav_ter_metagen_0_12m$seTE.random.w,
  z_value = crav_ter_metagen_0_12m$statistic.random.w,
  p_value = crav_ter_metagen_0_12m$pval.random.w
)
```

For an easier way to add the individual effect sizes for each subgroup in the final forest plot, we can create a split of the data frame.

```{r crav-ter-012m-subgroup-split, echo=TRUE, message=FALSE, warning=FALSE, include=TRUE}
# Split the previously defined data frame by each subordinate domain
crav_ter_subsplit_012m <- split(crav_ter_zp_subgroup_012m, crav_ter_zp_subgroup_012m$subgroup)
```

Now that we have created a list for the test statistics for each of the time points, we can create the final forest plot.
We set the overall effect to FALSE, as we do not want to pool the effects across reports of different time points in the same study.

```{r crav-ter-012m-forest, fig.height=7, fig.width=11, message=FALSE, warning=FALSE, include=TRUE, fig.cap="Forest plot of short-, intermediate-, long-term effects on craving"}
# Now plot the forest plot again with new subgroup names
forest(crav_ter_metagen_0_12m,
       prediction = FALSE,
       prediction.subgroup = FALSE,
       layout = "BMJ",
       subgroup = TRUE,
       overall = FALSE,
       random = TRUE,
       common = FALSE,
       test.subgroup = FALSE,
       print.stat = FALSE,
       print.I2 = TRUE,
       print.Q = TRUE,
       print.pval.Q = TRUE,
       print.tau2 = FALSE,
       label.left = "Favors Control",
       label.right = "Favors Intervention",
       spacing = 1.2,
       fontsize = 10,
       digits = 2,
       leftcols = c("studlab", "e_n", "e_crav_mean", "e_crav_sd", "c_n", "c_crav_mean",
                    "c_crav_sd"),
       leftlabs = c("Study", "Intv. (n)", "Mean", "SD", 
                    "Ctrl. (n)", "Mean", "SD"),
       just.addcols = "center"
       )

# Add a footer for the test statistics of the effects after 0-3 months
footer_ter_03_crav <- paste0(
  "Subgroup effect | ",
  paste0(
    crav_ter_subsplit_012m$`0-3 months`,
    ": z = ", round(crav_ter_subsplit_012m$`0-3 months`$z_value, 2),
    ", p = ", formatC(crav_ter_subsplit_012m$`0-3 months`$p_value, digits = 2)
  )
)

# Add a footer for the test statistics of the effects after 6 months
footer_ter_6_crav <- paste0(
  "Subgroup effect | ",
  paste0(
    crav_ter_subsplit_012m$`6 months`,
    ": z = ", round(crav_ter_subsplit_012m$`6 months`$z_value, 2),
    ", p = ", formatC(crav_ter_subsplit_012m$`6 months`$p_value, digits = 2)
  )
)

# Add a footer for the test statistics of the effects after 12 months
footer_ter_12_crav <- paste0(
  "Subgroup effect | ",
  paste0(
    crav_ter_subsplit_012m$`12 months`,
    ": z = ", round(crav_ter_subsplit_012m$`12 months`$z_value, 2),
    ", p = ", formatC(crav_ter_subsplit_012m$`12 months`$p_value, digits = 2)
  )
)

# Adjust the footer for the 0-3 month time point right below the subgroup
grid.text(footer_ter_03_crav, x = 0.098, y = 0.4,
          just = "left", gp = gpar(fontsize = 8))

# Adjust the footer for the 6 month time point right below the subgroup
grid.text(footer_ter_6_crav, x = 0.098, y = 0.2,
          just = "left", gp = gpar(fontsize = 8))

# Adjust the footer for the 12 month time point right below the subgroup
grid.text(footer_ter_12_crav, x = 0.098, y = 0.06,
          just = "left", gp = gpar(fontsize = 8))
```

### 4.3.5 Publication bias for intermediate effects on craving

As we only identified two studies for the intermediate time point, a visual inspection for asymmetry will not be meaningful nor will there be sufficient power for an Egger's test.

### 4.3.6 Publication bias for long-term effects on craving

As we only identified one study for the long-term time point, a visual inspection for asymmetry will not be meaningful nor will there be sufficient power for an Egger's test.

# 5. Exports of data and visual plots

In this final section, we extract the calculated effect sizes as a new Excel spreadsheet named "Calculated Effect Sizes", which can be uploaded to a repository or as supplementary material for publication.
Then we will be calculating the weights for the RoB-summary and exporting it as a new csv-file.
Finally, we export the weighted RoB-summary plot and some of the forest plots of our meta-analyses in high resolution, which will be needed for the final manuscript.

## 5.1 Data export

For keeping our original terminology for our extracted data, we want to export our data set with the calculated effect sizes with an additional column containing the study ID, which refers to separate reports of the same study that is defined by a combination of a number and a letter (i.e., denoting a certain report for a specific time point).
First, we define a new list reversing the previously defined study labels.

```{r define-old-study-labels, echo=TRUE, message=FALSE, warning=FALSE, include=TRUE}
# Swap names and values
study_labels_reversed <- setNames(names(study_labels), study_labels)
```

We can then add a column with the study ID to our full data frame for CA.
However, we need to manually correct the APA author labels to the original study IDs.

```{r ca-assign-old-labels, echo=TRUE, message=FALSE, warning=FALSE, include=TRUE}
# Add study ID using reversed labels
ca_d_full_0_12m <- ca_d_full_0_12m %>%
  mutate(study_id = study_labels_reversed[study]) %>%
  
# Correct specific study IDs based on row ID
mutate(study_id = case_when(
  row_id == 1  ~ "3c_dubuson_2021",
  row_id == 10 ~ "16b_schoenmakers_2010",
  row_id == 13 ~ "3d_dubuson_2021",
  row_id == 14 ~ "5c_manning_2022",
  row_id == 15 ~ "9c_kumar_2019",
  row_id == 16 ~ "15b_schenkel_2024",
  row_id == 17 ~ "2b_uyl_2018",
  row_id == 18 ~ "3e_dubuson_2021",
  row_id == 20 ~ "5d_manning_2022",
  row_id == 21 ~ "12b_peerenboom_2022",
  row_id == 23 ~ "14b_schenkel_2023",
  row_id == 24 ~ "15c_schenkel_2024",
  row_id == 25 ~ "18b_wiers_2011",
  TRUE ~ study_id  # Keep original study ID if no manual correction needed
  )) %>%
  
# Reorder columns: put study_id immediately after row ID
relocate(study_id, .after = row_id) %>%
  
# Sort by row ID ascending
arrange(row_id)
```

This can be repeated for the full data frame for alcohol reduction, and manually change three of the APA author labels back to their original study IDs.

```{r red-assign-old-labels, echo=TRUE, message=FALSE, warning=FALSE, include=TRUE}
# Add study ID using reversed labels
red_d_full_0_12m <- red_d_full_0_12m %>%
  mutate(study_id = study_labels_reversed[study]) %>%
  
# Correct specific study IDs based on row ID
mutate(study_id = case_when(
  row_id == 6  ~ "5c_manning_2022",
  row_id == 7 ~ "10c_laurens_2023",
  row_id == 8 ~ "5d_manning_2022",
  TRUE ~ study_id  # Keep original study ID if no manual correction needed
  )) %>%
  
# Reorder columns: put study_id immediately after row ID
relocate(study_id, .after = row_id) %>%
  
# Sort by row ID ascending
arrange(row_id)

# Change the time point label back to original name
names(red_d_full_0_12m)[names(red_d_full_0_12m) == "Time point"] <- "time_point"
```

Finally, we can repeat the step for the full data frame for craving, and manually change the APA author labels back to their original study IDs.

```{r crav-assign-old-labels, echo=TRUE, message=FALSE, warning=FALSE, include=TRUE}
# Add study ID using reversed labels
crav_d_full_0_12m <- crav_d_full_0_12m %>%
  mutate(study_id = study_labels_reversed[study]) %>%
  
# Correct specific study IDs based on row ID
mutate(study_id = case_when(
  row_id == 10  ~ "5g_garfield_2022",
  row_id == 11 ~ "10c_laurens_2023",
  row_id == 12 ~ "5h_garfield_2022",
  TRUE ~ study_id  # Keep original study ID if no manual correction needed
  )) %>%
  
# Reorder columns: put study_id immediately after row ID
relocate(study_id, .after = row_id) %>%
  
# Sort by row ID ascending
arrange(row_id)

# Change the time point label back to original name
names(crav_d_full_0_12m)[names(crav_d_full_0_12m) == "Time point"] <- "time_point"
```

The last step is to export all the data frames into one Excel sheet, but categorized by "Abstinence", "Reduction" and "Craving", which will all have their own sheet.
We ensure that previously defined data frame for CA does not contain characters, which is achieved by converting the data columns.

```{r export-effect-sizes, echo=FALSE, message=FALSE, warning=FALSE, include=TRUE}
# Specify the columns you want to convert
cols_to_convert <- c("c_n", "c_abs", "c_non_abs", "e_n", "e_abs", "e_non_abs")

# Convert them to numeric (safely even if they are currently character)
ca_d_full_0_12m[cols_to_convert] <- lapply(ca_d_full_0_12m[cols_to_convert], function(x) as.numeric(as.character(x)))

# Create a new Excel workbook
exp_full_d <- createWorkbook()

# Add and write data to the first sheet: Abstinence
addWorksheet(exp_full_d, "Abstinence")
writeData(exp_full_d, sheet = "Abstinence", ca_d_full_0_12m)

# Add and write data to the second sheet: Reduction
addWorksheet(exp_full_d, "Reduction")
writeData(exp_full_d, sheet = "Reduction", red_d_full_0_12m)

# Add and write data to the first sheet: Craving
addWorksheet(exp_full_d, "Craving")
writeData(exp_full_d, sheet = "Craving", crav_d_full_0_12m)

# Save the workbook
saveWorkbook(exp_full_d, file = "Calculated Effect Sizes.xlsx", overwrite = TRUE)
```

Now we can turn to exporting the final data set for weighted RoB-summary.
First, we will need to extract the unique studies used for our primary analyses.

```{r rob-final-extraction, echo=TRUE, message=FALSE, warning=FALSE, include=TRUE}
# Define study IDs for CA
ca_rob <- c(
  "6_grieder_2022", "8b_kvamme_2019", "16b_schoenmakers_2010", "2b_uyl_2018",
  "9b_kumar_2019", "3c_dubuson_2021", "1_chen_2022", "17b_stein_2023",
  "18b_wiers_2011", "5b_manning_2022", "12a_peerenboom_2022", "14a_schenkel_2023",
  "4_eberl_2013", "13a_rinck_2018", "15a_schenkel_2024", "11_manning_2016"
)

# Define study IDs for alcohol reduction
red_rob <- c(
  "7c_garfield_2024", "10b_laurens_2023"
)

# Filter and select only needed columns in the data frame for CA
ca_d_rob <- ca_d_full_0_12m %>%
  filter(study_id %in% ca_rob) %>%
  select(study_id, study, SE)  # <- only these columns

# Filter and select only needed columns in the data frame for alcohol reduction
red_d_rob <- red_d_full_0_12m %>%
  filter(study_id %in% red_rob) %>%
  select(study_id, study, SE)

# Combine the two sets
rob_d_se <- bind_rows(ca_d_rob, red_d_rob)
```

With a new data frame only including the outcomes extracted and rated from our unique studies, we can calculate the absolute and relative weights using the SE.

```{r rob-weight-calc, echo=TRUE, message=FALSE, warning=FALSE, include=TRUE}
# Calculate weights
rob_d_weighted <- rob_d_se %>%
  mutate(weight = 1 / (SE^2)) %>%
  mutate(weight_percent = 100 * weight / sum(weight))
```

The relative weights can now be added to the final RoB-summary data and exported as a new csv-file named "Weighted RoB Data".
First, we need to ensure that the column named "Study" matches the new data frame, and we will also need to filter out two reports that are not unique studies [@garfield2022, @manning2021].

```{r export-rob-weighted, echo=TRUE, message=FALSE, warning=FALSE, include=TRUE}
# Rename 'study' to 'Study' in weighted_rob_d
rob_d_weighted <- rob_d_weighted %>%
  rename(Study = study)

# Merge weights (adjust column names if necessary)
rob_d_weighted <- rob_d %>%
  left_join(rob_d_weighted %>% select(Study, weight_percent),
            by = "Study")

# Remove double-reported studies
rob_d_weighted <- rob_d_weighted %>%
  filter(!Study %in% c("Garfield et al. (2022)*", "Manning et al. (2021)*"))

# Save new CSV as "Weighted RoB Data" in the working directory
write.csv(rob_d_weighted, "Weighted RoB Data.csv", row.names = FALSE)
```

Now we want to display the percentages, so that these can be reported in the manuscript.

```{r rob-summary-pct, echo=TRUE, message=FALSE, warning=FALSE, include=TRUE}
# Reshape to long format (excluding weight column)
rob_pct <- rob_d_weighted %>%
  pivot_longer(cols = D1:Overall, names_to = "Domain", values_to = "Judgment")

# Label domains and enforce correct domain order using factor
rob_labels <- c(
  D1 = "Randomization process",
  D2 = "Deviations from intended interventions",
  D3 = "Missing outcome data",
  D4 = "Measurement of the outcome",
  D5 = "Selection of the reported result",
  Overall = "Overall risk of bias"
)

# Use the label values to define order
domain_order <- rob_labels %>% unname()
rob_pct <- rob_pct %>%
  mutate(
    Domain = recode(Domain, !!!rob_labels),
    Domain = factor(Domain, levels = domain_order),
    Judgment = factor(Judgment, levels = c("Low", "Some concerns", "High"))  # <-- key line
  )

# Count and calculate percentage
rob_pct_summary <- rob_pct %>%
  group_by(Domain, Judgment) %>%
  summarise(n = n(), .groups = "drop") %>%
  group_by(Domain) %>%
  mutate(Percent = round(n / sum(n) * 100, 1))

# Wide format summary table
rob_pct_summary <- rob_pct_summary %>%
  select(Domain, Judgment, Percent) %>%
  pivot_wider(names_from = Judgment, values_from = Percent, values_fill = 0)

# Print the ordered summary table
print(rob_pct_summary)
```

## 5.2 Figure export

In this section we export some of the figures displayed in this report.
As the final manuscript will not include all of the figures displayed in this report, we only want to create high resolution exports for the files used in the manuscript.
The remaining plots and figures will be added to the supplementary material in a word-file using the images created by `knitr` and the corresponding knitted word-document.
We will export four figures in total and they follow the naming convention "fig_x\_", and as a flow-chart is included as the first figure in the manuscript, the figures will start with "fig_2\_".

We first export the summary of the RoB-assessment across all domains, but this time with the weighted summary data.
The figure will be exported as figure 2.

```{r export-rob-summary, echo=FALSE, fig.height=6, fig.width=10, message=FALSE, warning=FALSE, include=TRUE}
# Export the RoB summary plot (Figure 2 in final manuscript)
tiff("fig_2_rob_summary_plot.tiff", width = 8, height = 5, units = "in", res = 600)
rob_summary(rob_d_weighted, tool = "ROB2", weighted = FALSE)
invisible(dev.off())
```

We then export our forest plots, and as most of our identified studies included CA, we will only export the forest plots for our primary, secondary, and tertiary analyses for CA.
The plots for alcohol reduction and craving will be included in the supplementary material.

The first forest plot for our primary analysis on short-term effects on CA, will be exported as figure 3.

```{r export-ca-3m-forest, fig.height=7, fig.width=12, message=FALSE, warning=FALSE, include=TRUE}
# Export the forest plot for CA for 0-3 months
tiff("fig_3_ca_primary_forest_plot.tiff", width = 12, height = 7, units = "in", res = 600)
forest(ca_metagen_3m,
       prediction = TRUE,
       prediction.subgroup = TRUE,
       layout = "BMJ",
       subgroup = TRUE,
       overall = TRUE,
       random = TRUE,
       common = FALSE,
       test.subgroup = FALSE,
       print.stat = FALSE,
       print.I2 = TRUE,
       print.Q = TRUE,
       print.pval.Q = TRUE,
       print.tau2 = FALSE,
       label.left = "Favors Control",
       label.right = "Favors Intervention",
       spacing = 1.2,
       fontsize = 10,
       digits = 2,
       leftcols = c("studlab", "e_abs", "e_n", "c_abs", "c_n"),
       leftlabs = c("Study", "Intv. (events)", "Total (n)", 
                    "Ctrl. (events)", "Total (n)"),
       just.addcols = "center"
       )
# Add a footer for the test statistics of the effects for explicit cognition
footer_exp_ca_3m <- paste0(
  "Subgroup effect | ",
  paste0(
    ca_zp_subsplit_3m$`Explicit cognition`,
    ": z = ", round(ca_zp_subsplit_3m$`Explicit cognition`$z_value, 2),
    ", p = ", formatC(ca_zp_subsplit_3m$`Explicit cognition`$p_value, digits = 2)
  )
)
# Add a footer for the test statistics of the effects for implicit cognition
footer_imp_ca_3m <- paste0(
  "Subgroup effect | ",
  paste0(
    ca_zp_subsplit_3m$`Implicit cognition`,
    ": z = ", round(ca_zp_subsplit_3m$`Implicit cognition`$z_value, 2),
    ", p = ", formatC(ca_zp_subsplit_3m$`Implicit cognition`$p_value, digits = 2)
  )
)
# Add a footer combining the test statistics for the overall effect
footer_over_ca_3m <- paste0(
  "Overall effect: ",
  paste0(
    "z = ", round(ca_zp_overall_3m$z_value, 2),
    ", p = ", formatC(ca_zp_overall_3m$p_value, digits = 2),
    collapse = "; "
  )
)
# Adjust the footer for the subgroup effects after explicit subgroup
grid.text(footer_exp_ca_3m, x = 0.092, y = 0.72,
          just = "left", gp = gpar(fontsize = 8))
# Adjust the footer for the subgroup effects after implicit subgroup
grid.text(footer_imp_ca_3m, x = 0.092, y = 0.21,
          just = "left", gp = gpar(fontsize = 8))
# Adjust the footer for the overall effect to the bottom left
grid.text(footer_over_ca_3m, x = 0.092, y = 0.045,
          just = "left", gp = gpar(fontsize = 9))
invisible(dev.off())
```

The second forest plot for our secondary analysis on short-term effects on CA, will be exported as figure 4.

```{r export-ca-3m-sec-forest, fig.height=9, fig.width=12, message=FALSE, warning=FALSE, include=TRUE}
# Export the forest plot for secondary analysis for CA (0-3 months)
tiff("fig_4_ca_secondary_forest_plot.tiff", width = 12, height = 9, units = "in", res = 600)
forest(ca_sec_metagen_3m,
       prediction = TRUE,
       prediction.subgroup = TRUE,
       layout = "BMJ",
       subgroup = TRUE,
       overall = TRUE,
       random = TRUE,
       common = FALSE,
       test.subgroup = FALSE,
       print.stat = FALSE,
       print.I2 = TRUE,
       print.Q = TRUE,
       print.pval.Q = TRUE,
       print.tau2 = FALSE,
       label.left = "Favors Control",
       label.right = "Favors Intervention",
       spacing = 1.2,
       fontsize = 10,
       digits = 2,
       leftcols = c("studlab", "e_abs", "e_n", "c_abs", "c_n"),
       leftlabs = c("Study", "Intv. (events)", "Total (n)", 
                    "Ctrl. (events)", "Total (n)"),
       just.addcols = "center"
       )
# Add a footer for the test statistics of the effects for executive functions
footer_sec_exft_ca_3m <- paste0(
  "Subgroup effect | ",
  paste0(
    ca_sec_subsplit_3m$`Executive functions`,
    ": z = ", round(ca_sec_subsplit_3m$`Executive functions`$z_value, 2),
    ", p = ", formatC(ca_sec_subsplit_3m$`Executive functions`$p_value, digits = 2)
  )
)
# Add a footer for the test statistics of the effects for approach bias
footer_sec_apbm_ca_3m <- paste0(
  "Subgroup effect | ",
  paste0(
    ca_sec_subsplit_3m$`Approach bias`,
    ": z = ", round(ca_sec_subsplit_3m$`Approach bias`$z_value, 2),
    ", p = ", formatC(ca_sec_subsplit_3m$`Approach bias`$p_value, digits = 2)
  )
)
# Add a footer for the test statistics of the effects for attentional bias
footer_sec_atbm_ca_3m <- paste0(
  "Subgroup effect | ",
  paste0(
    ca_sec_subsplit_3m$`Attentional bias`,
    ": z = ", round(ca_sec_subsplit_3m$`Attentional bias`$z_value, 2),
    ", p = ", formatC(ca_sec_subsplit_3m$`Attentional bias`$p_value, digits = 2)
  )
)
# Add a footer for the test statistics of the effects for inhibitory bias
footer_sec_itbm_ca_3m <- paste0(
  "Subgroup effect | ",
  paste0(
    ca_sec_subsplit_3m$`Inhibitory bias`,
    ": z = ", round(ca_sec_subsplit_3m$`Inhibitory bias`$z_value, 2),
    ", p = ", formatC(ca_sec_subsplit_3m$`Inhibitory bias`$p_value, digits = 2)
  )
)
# Add a footer combining the test statistics for the overall effect
footer_sec_over_ca_3m <- paste0(
  "Overall effect: ",
  paste0(
    "z = ", round(ca_sec_zp_overall_3m$z_value, 2),
    ", p = ", formatC(ca_sec_zp_overall_3m$p_value, digits = 2),
    collapse = "; "
  )
)
# Adjust the footer for the executive functions right below the subgroup
grid.text(footer_sec_exft_ca_3m, x = 0.091, y = 0.805,
          just = "left", gp = gpar(fontsize = 8))
# Adjust the footer for the approach bias right below the subgroup
grid.text(footer_sec_apbm_ca_3m, x = 0.091, y = 0.57,
          just = "left", gp = gpar(fontsize = 8))
# Adjust the footer for the attentional bias right below the subgroup
grid.text(footer_sec_atbm_ca_3m, x = 0.091, y = 0.378,
          just = "left", gp = gpar(fontsize = 8))
# Adjust the footer for the inhibitory bias right below the subgroup
grid.text(footer_sec_itbm_ca_3m, x = 0.091, y = 0.145,
          just = "left", gp = gpar(fontsize = 8))
# Adjust the footer for the overall effect to the bottom left
grid.text(footer_sec_over_ca_3m, x = 0.090, y = 0.025,
          just = "left", gp = gpar(fontsize = 9))
invisible(dev.off())
```

The final forest plot for our tertiary analysis on short-, intermediate-, and long-term effects on CA, will be exported as figure 5.

```{r export-ca-012m-ter-forest, fig.height=12, fig.width=12, message=FALSE, warning=FALSE, include=TRUE}
# Export the forest plot for tertiary analysis for CA (all time points)
tiff("fig_5_ca_tertiary_forest_plot.tiff", width = 12, height = 12, units = "in", res = 600)
forest(ca_ter_metagen_0_12m,
       prediction = TRUE,
       prediction.subgroup = TRUE,
       layout = "BMJ",
       subgroup = TRUE,
       overall = FALSE,
       random = TRUE,
       common = FALSE,
       test.subgroup = FALSE,
       print.stat = FALSE,
       print.I2 = TRUE,
       print.Q = TRUE,
       print.pval.Q = TRUE,
       print.tau2 = FALSE,
       label.left = "Favors Control",
       label.right = "Favors Intervention",
       spacing = 1.2,
       fontsize = 10,
       digits = 2,
       leftcols = c("studlab", "e_abs", "e_n", "c_abs", "c_n"),
       leftlabs = c("Study", "Intv. (events)", "Total (n)", 
                    "Ctrl. (events)", "Total (n)"),
       just.addcols = "center"
       )
# Add a footer for the test statistics of the effects after 0-3 months
footer_ter_03_ca <- paste0(
  "Subgroup effect | ",
  paste0(
    ca_ter_subsplit_012m$`0-3 months`,
    ": z = ", round(ca_ter_subsplit_012m$`0-3 months`$z_value, 2),
    ", p = ", formatC(ca_ter_subsplit_012m$`0-3 months`$p_value, digits = 2)
  )
)
# Add a footer for the test statistics of the effects after 6 months
footer_ter_6_ca <- paste0(
  "Subgroup effect | ",
  paste0(
    ca_ter_subsplit_012m$`6 months`,
    ": z = ", round(ca_ter_subsplit_012m$`6 months`$z_value, 2),
    ", p = ", formatC(ca_ter_subsplit_012m$`6 months`$p_value, digits = 2)
  )
)
# Add a footer for the test statistics of the effects after 12 months
footer_ter_12_ca <- paste0(
  "Subgroup effect | ",
  paste0(
    ca_ter_subsplit_012m$`12 months`,
    ": z = ", round(ca_ter_subsplit_012m$`12 months`$z_value, 2),
    ", p = ", formatC(ca_ter_subsplit_012m$`12 months`$p_value, digits = 2)
  )
)
# Adjust the footer for the 0-3 month time point right below the subgroup
grid.text(footer_ter_03_ca, x = 0.114, y = 0.56,
          just = "left", gp = gpar(fontsize = 8))
# Adjust the footer for the 6 month time point right below the subgroup
grid.text(footer_ter_6_ca, x = 0.114, y = 0.3825,
          just = "left", gp = gpar(fontsize = 8))
# Cover up unwanted group heterogeneity statistics
grid.rect(
  x = 0.1,
  y = 0.1,
  width = 0.6,
  height = 0.02,
  gp = gpar(fill = "white", col = NA)
)
# Adjust the footer for the 12 month time point right below the subgroup
grid.text(footer_ter_12_ca, x = 0.114, y = 0.1,
          just = "left", gp = gpar(fontsize = 8))
invisible(dev.off())
```

\newpage

# 6. R packages used

Some of the auxiliary packages used in this analysis report can be outputted using the package `grateful` by @rodriguez-sanchezaut2025.
The version number and the corresponding reference of the package are listed next to the package name in the package below.

```{r packages-overview, echo=TRUE, message=FALSE, warning=FALSE, include=TRUE}
# Add summary of the packages used except the meta-package
cite_packages(output = "table", out.dir = ".")
```

\newpage

# 7. References
